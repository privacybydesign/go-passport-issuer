FROM golang:1.24-bookworm AS backend-build

WORKDIR /app/backend

# Imagick (IM6) build deps
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential pkg-config libmagickwand-6.q16-dev \
  && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY . .
RUN cd backend && go mod download

# Run tests with coverage; write to /coverage inside the container.
# In CI we'll mount a host dir to /coverage so we can upload the file.
CMD cd backend && \
    go test ./... -v -covermode=atomic -coverprofile=/coverage/coverage.out
