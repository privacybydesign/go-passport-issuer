package document

import (
	"go-passport-issuer/models"
	"testing"

	"github.com/gmrtd/gmrtd/cms"
	"github.com/stretchr/testify/require"
)

// This test uses DG2 and SOD and Certificate belonging to passport due to no available
// eDL test data, but the EDL passive authentication logic should work for any corresponding DG, SOD and Cert

func createTestEDLRequest(sod string) models.ValidationRequest {
	return models.ValidationRequest{
		DataGroups: map[string]string{
			"DG2": dg2Hex,
		},
		EFSOD: sod,
	}
}

func setupEdlVerifyTest(t *testing.T, createRequest func(string) models.ValidationRequest, sod string) (models.ValidationRequest, cms.CertPool) {
	t.Helper()
	data := createRequest(sod)
	trustedCerts := createTrustedCertPool(t, testCsca)
	return data, trustedCerts
}

func TestPassiveAuthenticationEDL_InvalidInputs(t *testing.T) {
	_, trustedCerts := setupEdlVerifyTest(t, createTestEDLRequest, testSodHex)

	for _, tt := range invalidPassiveAuthInput {
		t.Run(tt.name, func(t *testing.T) {
			data := models.ValidationRequest{
				DataGroups: tt.dataGroups,
				EFSOD:      tt.efsod,
			}
			err := PassiveAuthenticationEDL(data, &trustedCerts)
			require.Error(t, err)
			require.Contains(t, err.Error(), tt.expectedError)
		})
	}
}

func TestPassiveAuthenticationEDL_WithRealSOD(t *testing.T) {
	data, trustedCerts := setupEdlVerifyTest(t, createTestEDLRequest, testSodHex)

	err := PassiveAuthenticationEDL(data, &trustedCerts)
	require.NoError(t, err)
}

// With a few changed bytes
var badSOD = "778207853082078106092A864886F70D010702A08207723082076E020103310D300B0609608648016503040201306E0606678108010101A06404623060020100300B0609608648016503040201304E30250201010420CA34A2808CA60C6671EC66F4E1229ADF0474BF1A7E099A05946B999438D511AD302502010204205F03553723906ACBE6B68B52F639F73B9F9E3C3135BC87E6E3D511C922AC7D20A08204F8308204F4308202DCA0030201020204492EBA13300D06092A864886F70D01010B05003041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479301E170D3131303830313132353535335A170D3232313230313031323535335A304F310B3009060355040613026762310D300B060355040A1304756B7073310F300D060355040B13066C6F6E646F6E3120301E06035504031317446F63756D656E74205369676E696E67204B657920333530820122300D06092A864886F70D01010105000382010F003082010A0282010100CE65C9D95D8FADB3C2AEABAB99220F96B5880F69AE651B3A7A378E293099B343BD1CB58FD28F0FD2F0166EA05273ECA9A3BE315397A7C6951C3FD09DCFF864C5F4B763F89851C8F9632E63D819C9EC905B90DA9D78FE0376F7218FE4B51EE88C66ECED44F4F98FEDFDBDD920484DA7AEE39E199196895DDC2C58ECF16B72D6E84770DE10793434C42FE01B8E7FC5DB7C38D7ACDEC5C1476CF1E69152E9D31CAEC122AF71280078AE054509F1CFEFC1340797FDAFCEAE5B4CBA8EDC7AB391DE69649CF9A33CA2596718E887C948EEA60BD99AA0E80C88FF94FA6FB78EEFAE98F4EC2CACC201D7EED96126292A23C4F9452D5EFF66333CC6DBE3E2EEDC3EC360DF0203010001A381E53081E2302B0603551D1004243022800F32303131303830313133323535335A810F32303131313130333133323535335A300E0603551D0F0101FF04040302078030630603551D1F045C305A3058A056A054A4523050310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479310D300B0603550403130443524C34301F0603551D230418301680144531A5B73BCF8BB27C7FAC88C74B4505F6C936B3301D0603551D0E0416041467B8149943C5F8C949BC846A34DBE7E05D241404300D06092A864886F70D01010B050003820201005BFB66391196171815A26AE99FD1653B7F6C9FFB751BBD69ADEF0B4182C043C4726FD826C8011BF12DA9374A79963613672C84289671EC31D53CA73E23E0A119F884B5D5836CE1F9DD03787624ABBDFEF475F16D5BFFFD719DE0B0FD1C0FE9D0E8064C6F77372CBBB00E1E43715A157EFB5F3D97E60A5018B6F07E7C735067FC73480B393D8945D09ED79F3D9C3F6299B7F2A2FC5829ABCE927C23010FE74788AF2AC7D38A08075C4559E256ECF8CB62BC27316FB477A79653A836EC03032CFA2FDF009EE6C9B5A102C91C381C0B941952A22AF5DAF9552A8A7F70D1F5847C8D3762CC7A2C0B44CC12A74C6CB410985641979B4CAD092A199A7371716592B9BC0A8691B60D830E13E749B31FFE120E0E2C98E2DE1C745ED16D3D2DF7205DDDC34C1B06413C28C9DC11C1F03F3E0A20321D8ACC13183EE003CE36DCA354E8053145F6055451C3F6A2A8E40998C5EF40609E431894C524CA9A7523B8B3BD667BD09F1F9E0EAC7602E1B8758F82EE61DA953E9B188ADF5A382D23EE4137F50B0A7AE8833AF55D5F0DD9E6E5D71B2A2543FBFAA2F7902D8E1BD656B6654264E108792E70C68227CE7F58C5C866D5CCFD3572941F21CFC2AA85EAEC84B4C6988C75BEC1711F11149356DC40119F4B023154BCED5B581FD71FEC2BC106D737E8D1F9704C5686A182C0148CA90B93CA17DD2797FBA2619F69D3F8474BC9D9493A33F45A318201EC308201E802010130493041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F726974790204492EBA13300B0609608648016503040201A048301506092A864886F70D01090331080606678108010101302F06092A864886F70D010904312204206A2DFFE58D6A59A5AAE942C2BAF9A585B4B20E63C4B7ED0CE4B497FFC7F80992303D06092A864886F70D01010A3030A00D300B0609608648016503040201A11A301806092A864886F70D010108300B0609608648016503040201A203020120048201007465E8179610CC7D48D7F2AB0A88FD939E5CAB0D7226874F5647AA1A97911CF61DED88DA44D1AEC330C7045E3B5DFB7A79F19698C12D659BC37B8E98375D130ADEC2BD6688A57C996D9FC2DC8E0E2594BFA3E43E4FD7E63A7895435182D566F749C39FB4E948658E58769F871E665FA92C4C620DF2940DA028C72F2B05B4FA35E16201BD912AB7F6E4C07116E6086724C2009C2C29C2B83050546EE29CB162B975EF2A9718CDEC2737518D282CBA5B11A95707EA3DC915047A8906181B3E4FE823EA34A5C1BF7A93D5510EA8A7A355385C344E76647EF73AFF9270CC678D6DBAD06088C950E2BFC2DF382E48D768ACC6E4217E09457011AC72EBB4DBABB81611"

func TestPassiveAuthenticationEDL_WithBadSOD(t *testing.T) {
	data, trustedCerts := setupEdlVerifyTest(t, createTestEDLRequest, badSOD)

	err := PassiveAuthenticationEDL(data, &trustedCerts)
	require.ErrorContains(t, err, "SOD signature verification failed")
}
