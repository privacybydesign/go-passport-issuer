package passport

import (
	"go-passport-issuer/models"
	"testing"
	"time"

	"github.com/gmrtd/gmrtd/cms"
	"github.com/gmrtd/gmrtd/document"
	"github.com/gmrtd/gmrtd/utils"
	"github.com/stretchr/testify/require"
)

func TestBoolToYesNo(t *testing.T) {
	t.Run("true converts to Yes", func(t *testing.T) {
		result := BoolToYesNo(true)
		require.Equal(t, "Yes", result)
	})

	t.Run("false converts to No", func(t *testing.T) {
		result := BoolToYesNo(false)
		require.Equal(t, "No", result)
	})
}

func TestParseDateTime(t *testing.T) {
	t.Run("valid date parses correctly", func(t *testing.T) {
		result, err := ParseDateTime("250315")
		require.NoError(t, err)
		require.Equal(t, 2025, result.Year())
		require.Equal(t, time.March, result.Month())
		require.Equal(t, 15, result.Day())
	})

	t.Run("another valid date", func(t *testing.T) {
		result, err := ParseDateTime("990101")
		require.NoError(t, err)
		require.Equal(t, 1999, result.Year())
		require.Equal(t, time.January, result.Month())
		require.Equal(t, 1, result.Day())
	})

	t.Run("invalid format - too short", func(t *testing.T) {
		_, err := ParseDateTime("25031")
		requireInvalidDateException(t, err)
	})

	t.Run("invalid format - too long", func(t *testing.T) {
		_, err := ParseDateTime("2503155")
		requireInvalidDateException(t, err)
	})

	t.Run("invalid date values", func(t *testing.T) {
		_, err := ParseDateTime("251399")
		require.Error(t, err)
		require.Contains(t, err.Error(), "error parsing date")
	})

	t.Run("empty string", func(t *testing.T) {
		_, err := ParseDateTime("")
		requireInvalidDateException(t, err)
	})
}

func requireInvalidDateException(t *testing.T, err error) {
	require.Error(t, err)
	require.Contains(t, err.Error(), "invalid date format")
}

func TestIsEuCitizen(t *testing.T) {
	t.Run("valid EU country uppercase", func(t *testing.T) {
		require.True(t, IsEuCitizen("NLD"))
		require.True(t, IsEuCitizen("DEU"))
		require.True(t, IsEuCitizen("FRA"))
		require.True(t, IsEuCitizen("ESP"))
		require.True(t, IsEuCitizen("ITA"))
	})

	t.Run("valid EU country lowercase", func(t *testing.T) {
		require.True(t, IsEuCitizen("nld"))
		require.True(t, IsEuCitizen("deu"))
		require.True(t, IsEuCitizen("fra"))
	})

	t.Run("valid EU country mixed case", func(t *testing.T) {
		require.True(t, IsEuCitizen("Nld"))
		require.True(t, IsEuCitizen("DeU"))
	})

	t.Run("non-EU country", func(t *testing.T) {
		require.False(t, IsEuCitizen("USA"))
		require.False(t, IsEuCitizen("GBR"))
		require.False(t, IsEuCitizen("CHE"))
		require.False(t, IsEuCitizen("NOR"))
	})

	t.Run("empty string", func(t *testing.T) {
		require.False(t, IsEuCitizen(""))
	})

	t.Run("all EU countries", func(t *testing.T) {
		euCountries := []string{
			"AUT", "BEL", "BGR", "HRV", "CYP",
			"CZE", "DNK", "EST", "FIN", "FRA",
			"DEU", "GRC", "HUN", "IRL", "ITA",
			"LVA", "LTU", "LUX", "MLT", "NLD",
			"POL", "PRT", "ROU", "SVK", "SVN",
			"ESP", "SWE",
		}
		for _, country := range euCountries {
			require.True(t, IsEuCitizen(country), "Country %s should be recognized as EU", country)
		}
	})
}

func TestPassiveAuthentication(t *testing.T) {
	tests := []struct {
		name          string
		dataGroups    map[string]string
		efsod         string
		certPool      *cms.CombinedCertPool
		expectedError string
	}{
		{
			name:          "empty data groups returns error",
			dataGroups:    map[string]string{},
			efsod:         "some_sod_data",
			certPool:      nil,
			expectedError: "no data groups found",
		},
		{
			name: "missing EF_SOD returns error",
			dataGroups: map[string]string{
				"DG1": "some_data",
			},
			efsod:         "",
			certPool:      nil,
			expectedError: "EF_SOD is missing",
		},
		{
			name: "invalid SOD returns error",
			dataGroups: map[string]string{
				"DG1": "some_data",
			},
			efsod:         "AABBCC",
			certPool:      &cms.CombinedCertPool{},
			expectedError: "failed to create SOD",
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			data := models.PassportValidationRequest{
				DataGroups: tt.dataGroups,
				EFSOD:      tt.efsod,
			}
			_, err := PassiveAuthentication(data, tt.certPool)
			require.Error(t, err)
			require.Contains(t, err.Error(), tt.expectedError)
		})
	}
}

func TestPassiveAuthenticationWithRealSOD(t *testing.T) {
	// Test that PassiveAuthentication can parse real SOD data from gmrtd test cases
	// based on an expired UK passport
	// Source: https://github.com/gmrtd/gmrtd/blob/main/passiveauth/passive_auth_test.go

	var sodHex = "778207853082078106092A864886F70D010702A08207723082076E020103310D300B0609608648016503040201306E0606678108010101A06404623060020100300B0609608648016503040201304E30250201010420CA34A2808CA60C6671EC66F4E1229ADF0474BF1A7E099A05946B999438D511AD302502010204205F03553723906ACBE6B68B52F639F73B9F9E3C3135BC87E6E3D511C922AC7D20A08204F8308204F4308202DCA0030201020204492EBA13300D06092A864886F70D01010B05003041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479301E170D3131303830313132353535335A170D3232313230313031323535335A304F310B3009060355040613026762310D300B060355040A1304756B7073310F300D060355040B13066C6F6E646F6E3120301E06035504031317446F63756D656E74205369676E696E67204B657920333530820122300D06092A864886F70D01010105000382010F003082010A0282010100CE65C9D95D8FADB3C2AEABAB99220F96B5880F69AE651B3A7A378E293099B343BD1CB58FD28F0FD2F0166EA05273ECA9A3BE315397A7C6951C3FD09DCFF864C5F4B763F89851C8F9632E63D819C9EC905B90DA9D78FE0376F7218FE4B51EE88C66ECED44F4F98FEDFDBDD920484DA7AEE39E199196895DDC2C58ECF16B72D6E84770DE10793434C42FE01B8E7FC5DB7C38D7ACDEC5C1476CF1E69152E9D31CAEC122AF71280078AE054509F1CFEFC1340797FDAFCEAE5B4CBA8EDC7AB391DE69649CF9A33CA2596718E887C948EEA60BD99AA0E80C88FF94FA6FB78EEFAE98F4EC2CACC201D7EED96126292A23C4F9452D5EFF66333CC6DBE3E2EEDC3EC360DF0203010001A381E53081E2302B0603551D1004243022800F32303131303830313133323535335A810F32303131313130333133323535335A300E0603551D0F0101FF04040302078030630603551D1F045C305A3058A056A054A4523050310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479310D300B0603550403130443524C34301F0603551D230418301680144531A5B73BCF8BB27C7FAC88C74B4505F6C936B3301D0603551D0E0416041467B8149943C5F8C949BC846A34DBE7E05D241404300D06092A864886F70D01010B050003820201005BFB66391196171815A26AE99FD1653B7F6C9FFB751BBD69ADEF0B4182C043C4726FD826C8011BF12DA9374A79963613672C84289671EC31D53CA73E23E0A119F884B5D5836CE1F9DD03787624ABBDFEF475F16D5BFFFD719DE0B0FD1C0FE9D0E8064C6F77372CBBB00E1E43715A157EFB5F3D97E60A5018B6F07E7C735067FC73480B393D8945D09ED79F3D9C3F6299B7F2A2FC5829ABCE927C23010FE74788AF2AC7D38A08075C4559E256ECF8CB62BC27316FB477A79653A836EC03032CFA2FDF009EE6C9B5A102C91C381C0B941952A22AF5DAF9552A8A7F70D1F5847C8D3762CC7A2C0B44CC12A74C6CB410985641979B4CAD092A199A7371716592B9BC0A8691B60D830E13E749B31FFE120E0E2C98E2DE1C745ED16D3D2DF7205DDDC34C1B06413C28C9DC11C1F03F3E0A20321D8ACC13183EE003CE36DCA354E8053145F6055451C3F6A2A8E40998C5EF40609E431894C524CA9A7523B8B3BD667BD09F1F9E0EAC7602E1B8758F82EE61DA953E9B188ADF5A382D23EE4137F50B0A7AE8833AF55D5F0DD9E6E5D71B2A2543FBFAA2F7902D8E1BD656B6654264E108792E70C68227CE7F58C5C866D5CCFD3572941F21CFC2AA85EAEC84B4C6988C75BEC1711F11149356DC40119F4B023154BCED5B581FD71FEC2BC106D737E8D1F9704C5686A182C0148CA90B93CA17DD2797FBA2619F69D3F8474BC9D9493A33F45A318201EC308201E802010130493041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F726974790204492EBA13300B0609608648016503040201A048301506092A864886F70D01090331080606678108010101302F06092A864886F70D010904312204206A2DFFE58D6A59A5AAE942C2BAF9A585B4B20E63C4B7ED0CE4B497FFC7F80992303D06092A864886F70D01010A3030A00D300B0609608648016503040201A11A301806092A864886F70D010108300B0609608648016503040201A203020120048201007465E8179610CC7D48D7F2AB0A88FD939E5CAB0D7226874F5647AA1A97911CF61DED88DA44D1AEC330C7045E3B5DFB7A79F19698C12D659BC37B8E98375D130ADEC2BD6688A57C996D9FC2DC8E0E2594BFA3E43E4FD7E63A7895435182D566F749C39FB4E948658E58769F871E665FA92C4C620DF2940DA028C72F2B05B4FA35E16201BD912AB7F6E4C07116E6086724C2009C2C29C2B83050546EE29CB162B975EF2A9718CDEC2737518D282CBA5B11A95707EA3DC915047A8906181B3E4FE823EA34A5C1BF7A93D5510EA8A7A355385C344E76647EF73AFF9270CC678D6DBAD06088C950E2BFC2DF382E48D765ACC6E4207E09457011AC72EBB4DBABB81611"
	var dg1Hex = "615B5F1F58503C47425253414E444552534F4E3C3C4F534341523C434841524C45533C4544574152443C3C3C3C3C3C3C3C30393932353036393236474252373830343035364D323230373137393C3C3C3C3C3C3C3C3C3C3C3C3C3C3032"

	var csca = utils.HexToBytes("308205FA308203E2A0030201020204492EAE16300D06092A864886F70D01010B05003041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479301E170D3130303332343134303230315A170D3236303732343134333230315A3041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F7269747930820222300D06092A864886F70D01010105000382020F003082020A0282020100C3583682D60EE9DB5E77F3CD27F02C8657ABA30C70A21EBC33FCAFA8E96B5806A090EF29CDC8A4A286F750C4F237CE89A207D460DED39854CFF2BA8F4E7807C655FE1B60E7459FF7E24DE2806EA6823BA8B3DD0A00C80B3DCB8BAE3C4620D9F5A81E3144E7805C96F147AFB13D6C9BAAB3D469EFCA9EADACAD81ED623FCCA82263D72350F553C17DE29352F937CA3EEFDAA902FE718EFC5F90CE9B35027E5F56CD92FDE396B2ACD2C8A83A7F5712CF7DF298607D072B8E82C5DD94BE323D293ADBD25B4F53467AAAE53E92BDD23E26B5501DA24B53E1F492917CA0FA8C59680FB17C952AC642944639B385A06315C251B204DD922E2F86A1D40F1FE3626E602D8D9ED0870C5D0E86ACB0E3845557E63CBB327D9EFFECD317A31FA337AEAC6F9304EB59B63DFEA4D7EC7AC94891D5D8B14F4FB4DB1AA4A88AD5B339FE7DCB460F8231F5B0628A6EA75C3FC252BF00C0D54D850D489346F3753A476A0EA237CAF9001CE729BB2EC2CEA6368F040A2B1B1108A2133EFFE4CA369D043D58A72D0AC1202138CCA1A370B26D576DA079DBDD6C59989F1E40F670AF27E28231ED3F7A5C7F1F699B9AB217F7125993CDA5C0B25147A0C37D08098B85D8B4F231303B1DF92EFAF03E31D92DE00D6971FD4D43971C318DCCB3F1FE908520F5AA788EADE562D0B23F85FF76340C5D181811B2C19529387807EBDD7C5AB09D971F0D3AB516AD0203010001A381F93081F6300E0603551D0F0101FF04040302010630120603551D130101FF040830060101FF02010030630603551D1F045C305A3058A056A054A4523050310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479310D300B0603550403130443524C31302B0603551D1004243022800F32303130303332343134303230315A810F32303236303732343134333230315A301F0603551D230418301680144531A5B73BCF8BB27C7FAC88C74B4505F6C936B3301D0603551D0E041604144531A5B73BCF8BB27C7FAC88C74B4505F6C936B3300D06092A864886F70D01010B0500038202010054F23F6A723698B06338E7A37FB2C740506E2175970C76E20D629D0AB5557359360826E7A611B3748470C1E7995952547C1BB790F4899D258F9127F6C4730F5FF63A8498EAEB50FAF767283B73325B968B497E8C6361073EC25DA7E4C225F36E5870D5874F11BC102F4DC2FEE784F3B3CB9AF3BD3C55F5A72C1883EB2632153B16F594AA086D549228CF0013199D66899181BE47AC0EF37D5F4FE7CB23B8565CD7F4099968DD90791E8EAAE871914BB25C4ABC5556D8387D4964CD87051088431FC32AAC31E37DCEE14BA835C9618E1365216BD227563D99520FD03B101CA7EABFE326BA71B4DE40DA328B2F65E99B591B01FC132C9713BF525238FEDE68A509653C196AA73404D970509D7112EFBC62F385F9642DDE0FBFC7228E0AB388C69E0304B617CC56E4B6253FBD005B22AFF67420F51069AE8D2DC9E5F076E33016AA4E1BBE11A3B79CBA4E41002021639126B7DDC79DC6DF2CD2C1DDB706B825125514F8E5797C409B1B69A8EADA1E95E1FAD139F7C1E189008A5BAB74DF7E87830AF1FBDFC27BD1985CF8DFE5C631AA4F7C0D439D80FB35B34F7722FC0EFBD2B88B4C4BC918EE4E5BD868EB49E1B6858696B364BCEC7D69E494E7DA8198D69A6ABE1F31D01502F5E78550808C2F14CD447E0E56ACDF01A5A145C52EC867232091F1C71800654CC7529557C3414667F9711275B36E92196DD8D600587D4E93FD08D3")

	data := models.PassportValidationRequest{
		DataGroups: map[string]string{
			"DG1": dg1Hex,
		},
		EFSOD: sodHex,
	}

	var trustedCerts cms.GenericCertPool
	err := trustedCerts.Add(csca)
	if err != nil {
		t.Fatalf("unexpected error (trustedCerts.Add): %s", err)
	}

	// Test that SOD can be parsed correctly and that passive auth works.
	_, err = PassiveAuthentication(data, &trustedCerts)
	require.NoError(t, err)

}

func TestActiveAuthentication(t *testing.T) {
	tests := []struct {
		name      string
		nonce     string
		signature string
	}{
		{
			name:      "missing nonce returns false with no error",
			nonce:     "",
			signature: "signature",
		},
		{
			name:      "missing signature returns false with no error",
			nonce:     "nonce",
			signature: "",
		},
		{
			name:      "missing DG15 returns false with no error",
			nonce:     "nonce",
			signature: "signature",
		},
		{
			name:      "all missing returns false with no error",
			nonce:     "",
			signature: "",
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			data := models.PassportValidationRequest{
				Nonce:               tt.nonce,
				ActiveAuthSignature: tt.signature,
			}
			doc := document.Document{}
			result, err := ActiveAuthentication(data, doc)
			require.NoError(t, err)
			require.False(t, result)
		})
	}
}
