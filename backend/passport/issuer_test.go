package passport

import (
	"fmt"
	"go-passport-issuer/models"
	"testing"
	"time"

	"github.com/gmrtd/gmrtd/cms"
	"github.com/gmrtd/gmrtd/document"
	"github.com/gmrtd/gmrtd/utils"
	"github.com/stretchr/testify/require"
)

func TestBoolToYesNo(t *testing.T) {
	t.Run("true converts to Yes", func(t *testing.T) {
		result := BoolToYesNo(true)
		require.Equal(t, "Yes", result)
	})

	t.Run("false converts to No", func(t *testing.T) {
		result := BoolToYesNo(false)
		require.Equal(t, "No", result)
	})
}

func TestParseExpiryDate(t *testing.T) {
	t.Run("valid date parses correctly", func(t *testing.T) {
		result, err := ParseExpiryDate("250315")
		require.NoError(t, err)
		require.Equal(t, 2025, result.Year())
		require.Equal(t, time.March, result.Month())
		require.Equal(t, 15, result.Day())
	})

	t.Run("one year after current year doesn't get 100 subtracted", func(t *testing.T) {
		now := time.Now()
		nextYear := now.Year()%100 + 1
		result, err := ParseExpiryDate(fmt.Sprintf("%v0101", nextYear))
		require.NoError(t, err)
		require.Equal(t, result.Year(), now.Year()+1)
		require.Equal(t, result.Month(), time.January)
		require.Equal(t, result.Day(), 1)
	})

	t.Run("30 years before now year get 100 years added", func(t *testing.T) {
		thirtyYearsAgo := time.Now().AddDate(-30, 0, 0)
		thirtyYearsAgoMod := thirtyYearsAgo.Year() % 100
		result, err := ParseExpiryDate(fmt.Sprintf("%v0101", thirtyYearsAgoMod))
		require.NoError(t, err)
		require.Equal(t, result.Year(), thirtyYearsAgo.Year()+100)
		require.Equal(t, result.Month(), time.January)
		require.Equal(t, result.Day(), 1)
	})

	t.Run("29 years before now is untouched", func(t *testing.T) {
		thirtyYearsAgo := time.Now().AddDate(-29, 0, 0)
		thirtyYearsAgoMod := thirtyYearsAgo.Year() % 100
		result, err := ParseExpiryDate(fmt.Sprintf("%v0101", thirtyYearsAgoMod))
		require.NoError(t, err)
		require.Equal(t, result.Year(), thirtyYearsAgo.Year())
		require.Equal(t, result.Month(), time.January)
		require.Equal(t, result.Day(), 1)
	})

	t.Run("30 years after now is untouched", func(t *testing.T) {
		thirtyYearsFromNow := time.Now().AddDate(30, 0, 0)
		thirtyYearsFromNowMod := thirtyYearsFromNow.Year() % 100
		result, err := ParseExpiryDate(fmt.Sprintf("%v0101", thirtyYearsFromNowMod))
		require.NoError(t, err)
		require.Equal(t, result.Year(), thirtyYearsFromNow.Year())
		require.Equal(t, result.Month(), time.January)
		require.Equal(t, result.Day(), 1)
	})

	// the limit for the Go time parser is 1969
	t.Run("68 parses as 1968", func(t *testing.T) {
		result, err := ParseExpiryDate("680101")
		require.NoError(t, err)
		require.Equal(t, 2068, result.Year())
		require.Equal(t, time.January, result.Month())
		require.Equal(t, 1, result.Day())
	})

	// the limit for the Go time parser is 1969
	t.Run("69 parses as 2069", func(t *testing.T) {
		result, err := ParseExpiryDate("690101")
		require.NoError(t, err)
		require.Equal(t, 2069, result.Year())
		require.Equal(t, time.January, result.Month())
		require.Equal(t, 1, result.Day())
	})

	t.Run("invalid format - too short", func(t *testing.T) {
		_, err := ParseExpiryDate("25031")
		requireInvalidDateException(t, err)
	})

	t.Run("invalid format - too long", func(t *testing.T) {
		_, err := ParseExpiryDate("2503155")
		requireInvalidDateException(t, err)
	})

	t.Run("invalid date values", func(t *testing.T) {
		_, err := ParseExpiryDate("251399")
		require.Error(t, err)
		require.Contains(t, err.Error(), "error parsing date")
	})

	t.Run("empty string", func(t *testing.T) {
		_, err := ParseExpiryDate("")
		requireInvalidDateException(t, err)
	})
}

func TestParseDateOfBirth(t *testing.T) {
	t.Run("valid date parses correctly", func(t *testing.T) {
		result, err := ParseDateOfBirth("250315")
		require.NoError(t, err)
		require.Equal(t, 2025, result.Year())
		require.Equal(t, time.March, result.Month())
		require.Equal(t, 15, result.Day())
	})

	t.Run("one year after current year gets 100 subtracted", func(t *testing.T) {
		nextYear := time.Now().Year()%100 + 1
		result, err := ParseDateOfBirth(fmt.Sprintf("%v0101", nextYear))
		require.NoError(t, err)
		require.Equal(t, result.Year(), nextYear+1900)
		require.Equal(t, result.Month(), time.January)
		require.Equal(t, result.Day(), 1)
	})

	t.Run("current year doesn't get 100 subtracted", func(t *testing.T) {
		currYear := time.Now().Year() % 100
		result, err := ParseDateOfBirth(fmt.Sprintf("%v0101", currYear))
		require.NoError(t, err)
		require.Equal(t, result.Year(), time.Now().Year())
		require.Equal(t, result.Month(), time.January)
		require.Equal(t, result.Day(), 1)
	})

	t.Run("one year before current year doesn't get 100 subtracted", func(t *testing.T) {
		lastYear := time.Now().Year()%100 - 1
		result, err := ParseDateOfBirth(fmt.Sprintf("%v0101", lastYear))
		require.NoError(t, err)
		require.Equal(t, result.Year(), time.Now().Year()-1)
		require.Equal(t, result.Month(), time.January)
		require.Equal(t, result.Day(), 1)
	})

	// the limit for the Go time parser is 1969
	t.Run("1968 parses correctly", func(t *testing.T) {
		result, err := ParseDateOfBirth("680101")
		require.NoError(t, err)
		require.Equal(t, 1968, result.Year())
		require.Equal(t, time.January, result.Month())
		require.Equal(t, 1, result.Day())
	})

	// the limit for the Go time parser is 1969
	t.Run("1969 parses correctly", func(t *testing.T) {
		result, err := ParseDateOfBirth("690101")
		require.NoError(t, err)
		require.Equal(t, 1969, result.Year())
		require.Equal(t, time.January, result.Month())
		require.Equal(t, 1, result.Day())
	})

	t.Run("another valid date", func(t *testing.T) {
		result, err := ParseDateOfBirth("990101")
		require.NoError(t, err)
		require.Equal(t, 1999, result.Year())
		require.Equal(t, time.January, result.Month())
		require.Equal(t, 1, result.Day())
	})

	t.Run("invalid format - too short", func(t *testing.T) {
		_, err := ParseDateOfBirth("25031")
		requireInvalidDateException(t, err)
	})

	t.Run("invalid format - too long", func(t *testing.T) {
		_, err := ParseDateOfBirth("2503155")
		requireInvalidDateException(t, err)
	})

	t.Run("invalid date values", func(t *testing.T) {
		_, err := ParseDateOfBirth("251399")
		require.Error(t, err)
		require.Contains(t, err.Error(), "error parsing date")
	})

	t.Run("empty string", func(t *testing.T) {
		_, err := ParseDateOfBirth("")
		requireInvalidDateException(t, err)
	})
}

func requireInvalidDateException(t *testing.T, err error) {
	require.Error(t, err)
	require.Contains(t, err.Error(), "invalid date format")
}

func TestIsEuCitizen(t *testing.T) {
	t.Run("valid EU country uppercase", func(t *testing.T) {
		require.True(t, IsEuCitizen("NLD"))
		require.True(t, IsEuCitizen("DEU"))
		require.True(t, IsEuCitizen("FRA"))
		require.True(t, IsEuCitizen("ESP"))
		require.True(t, IsEuCitizen("ITA"))
	})

	t.Run("valid EU country lowercase", func(t *testing.T) {
		require.True(t, IsEuCitizen("nld"))
		require.True(t, IsEuCitizen("deu"))
		require.True(t, IsEuCitizen("fra"))
	})

	t.Run("valid EU country mixed case", func(t *testing.T) {
		require.True(t, IsEuCitizen("Nld"))
		require.True(t, IsEuCitizen("DeU"))
	})

	t.Run("non-EU country", func(t *testing.T) {
		require.False(t, IsEuCitizen("USA"))
		require.False(t, IsEuCitizen("GBR"))
		require.False(t, IsEuCitizen("CHE"))
		require.False(t, IsEuCitizen("NOR"))
	})

	t.Run("empty string", func(t *testing.T) {
		require.False(t, IsEuCitizen(""))
	})

	t.Run("all EU countries", func(t *testing.T) {
		euCountries := []string{
			"AUT", "BEL", "BGR", "HRV", "CYP",
			"CZE", "DNK", "EST", "FIN", "FRA",
			"DEU", "GRC", "HUN", "IRL", "ITA",
			"LVA", "LTU", "LUX", "MLT", "NLD",
			"POL", "PRT", "ROU", "SVK", "SVN",
			"ESP", "SWE",
		}
		for _, country := range euCountries {
			require.True(t, IsEuCitizen(country), "Country %s should be recognized as EU", country)
		}
	})
}

func TestPassiveAuthentication(t *testing.T) {
	tests := []struct {
		name          string
		dataGroups    map[string]string
		efsod         string
		certPool      *cms.CombinedCertPool
		expectedError string
	}{
		{
			name:          "empty data groups returns error",
			dataGroups:    map[string]string{},
			efsod:         "some_sod_data",
			certPool:      nil,
			expectedError: "no data groups found",
		},
		{
			name: "missing EF_SOD returns error",
			dataGroups: map[string]string{
				"DG1": "some_data",
			},
			efsod:         "",
			certPool:      nil,
			expectedError: "EF_SOD is missing",
		},
		{
			name: "invalid SOD returns error",
			dataGroups: map[string]string{
				"DG1": "some_data",
			},
			efsod:         "AABBCC",
			certPool:      &cms.CombinedCertPool{},
			expectedError: "failed to create SOD",
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			data := models.PassportValidationRequest{
				DataGroups: tt.dataGroups,
				EFSOD:      tt.efsod,
			}
			_, err := PassiveAuthentication(data, tt.certPool)
			require.Error(t, err)
			require.Contains(t, err.Error(), tt.expectedError)
		})
	}
}

func TestPassiveAuthenticationWithRealSOD(t *testing.T) {
	// Test that PassiveAuthentication can parse real SOD data from gmrtd test cases
	// based on an expired UK passport
	// Source: https://github.com/gmrtd/gmrtd/blob/main/passiveauth/passive_auth_test.go

	var sodHex = "778207853082078106092A864886F70D010702A08207723082076E020103310D300B0609608648016503040201306E0606678108010101A06404623060020100300B0609608648016503040201304E30250201010420CA34A2808CA60C6671EC66F4E1229ADF0474BF1A7E099A05946B999438D511AD302502010204205F03553723906ACBE6B68B52F639F73B9F9E3C3135BC87E6E3D511C922AC7D20A08204F8308204F4308202DCA0030201020204492EBA13300D06092A864886F70D01010B05003041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479301E170D3131303830313132353535335A170D3232313230313031323535335A304F310B3009060355040613026762310D300B060355040A1304756B7073310F300D060355040B13066C6F6E646F6E3120301E06035504031317446F63756D656E74205369676E696E67204B657920333530820122300D06092A864886F70D01010105000382010F003082010A0282010100CE65C9D95D8FADB3C2AEABAB99220F96B5880F69AE651B3A7A378E293099B343BD1CB58FD28F0FD2F0166EA05273ECA9A3BE315397A7C6951C3FD09DCFF864C5F4B763F89851C8F9632E63D819C9EC905B90DA9D78FE0376F7218FE4B51EE88C66ECED44F4F98FEDFDBDD920484DA7AEE39E199196895DDC2C58ECF16B72D6E84770DE10793434C42FE01B8E7FC5DB7C38D7ACDEC5C1476CF1E69152E9D31CAEC122AF71280078AE054509F1CFEFC1340797FDAFCEAE5B4CBA8EDC7AB391DE69649CF9A33CA2596718E887C948EEA60BD99AA0E80C88FF94FA6FB78EEFAE98F4EC2CACC201D7EED96126292A23C4F9452D5EFF66333CC6DBE3E2EEDC3EC360DF0203010001A381E53081E2302B0603551D1004243022800F32303131303830313133323535335A810F32303131313130333133323535335A300E0603551D0F0101FF04040302078030630603551D1F045C305A3058A056A054A4523050310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479310D300B0603550403130443524C34301F0603551D230418301680144531A5B73BCF8BB27C7FAC88C74B4505F6C936B3301D0603551D0E0416041467B8149943C5F8C949BC846A34DBE7E05D241404300D06092A864886F70D01010B050003820201005BFB66391196171815A26AE99FD1653B7F6C9FFB751BBD69ADEF0B4182C043C4726FD826C8011BF12DA9374A79963613672C84289671EC31D53CA73E23E0A119F884B5D5836CE1F9DD03787624ABBDFEF475F16D5BFFFD719DE0B0FD1C0FE9D0E8064C6F77372CBBB00E1E43715A157EFB5F3D97E60A5018B6F07E7C735067FC73480B393D8945D09ED79F3D9C3F6299B7F2A2FC5829ABCE927C23010FE74788AF2AC7D38A08075C4559E256ECF8CB62BC27316FB477A79653A836EC03032CFA2FDF009EE6C9B5A102C91C381C0B941952A22AF5DAF9552A8A7F70D1F5847C8D3762CC7A2C0B44CC12A74C6CB410985641979B4CAD092A199A7371716592B9BC0A8691B60D830E13E749B31FFE120E0E2C98E2DE1C745ED16D3D2DF7205DDDC34C1B06413C28C9DC11C1F03F3E0A20321D8ACC13183EE003CE36DCA354E8053145F6055451C3F6A2A8E40998C5EF40609E431894C524CA9A7523B8B3BD667BD09F1F9E0EAC7602E1B8758F82EE61DA953E9B188ADF5A382D23EE4137F50B0A7AE8833AF55D5F0DD9E6E5D71B2A2543FBFAA2F7902D8E1BD656B6654264E108792E70C68227CE7F58C5C866D5CCFD3572941F21CFC2AA85EAEC84B4C6988C75BEC1711F11149356DC40119F4B023154BCED5B581FD71FEC2BC106D737E8D1F9704C5686A182C0148CA90B93CA17DD2797FBA2619F69D3F8474BC9D9493A33F45A318201EC308201E802010130493041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F726974790204492EBA13300B0609608648016503040201A048301506092A864886F70D01090331080606678108010101302F06092A864886F70D010904312204206A2DFFE58D6A59A5AAE942C2BAF9A585B4B20E63C4B7ED0CE4B497FFC7F80992303D06092A864886F70D01010A3030A00D300B0609608648016503040201A11A301806092A864886F70D010108300B0609608648016503040201A203020120048201007465E8179610CC7D48D7F2AB0A88FD939E5CAB0D7226874F5647AA1A97911CF61DED88DA44D1AEC330C7045E3B5DFB7A79F19698C12D659BC37B8E98375D130ADEC2BD6688A57C996D9FC2DC8E0E2594BFA3E43E4FD7E63A7895435182D566F749C39FB4E948658E58769F871E665FA92C4C620DF2940DA028C72F2B05B4FA35E16201BD912AB7F6E4C07116E6086724C2009C2C29C2B83050546EE29CB162B975EF2A9718CDEC2737518D282CBA5B11A95707EA3DC915047A8906181B3E4FE823EA34A5C1BF7A93D5510EA8A7A355385C344E76647EF73AFF9270CC678D6DBAD06088C950E2BFC2DF382E48D765ACC6E4207E09457011AC72EBB4DBABB81611"
	var dg1Hex = "615B5F1F58503C47425253414E444552534F4E3C3C4F534341523C434841524C45533C4544574152443C3C3C3C3C3C3C3C30393932353036393236474252373830343035364D323230373137393C3C3C3C3C3C3C3C3C3C3C3C3C3C3032"
	// Valid DG2 test data from gmrtd library - contains facial biometric data
	var dg2Hex = "758214397f618214340201017f6082142ca10c8002010187020101880200085f2e82141946414300303130000000141900010000140b00000000000000000000000000000000020100940046000000000000ffd8ffe000104a46494600010201004800480000ffe100e84578696600004d4d002a000000080006011200030000000100010000011a00050000000100000056011b0005000000010000005e012800030000000100020000021300030000000100010000876900040000000100000066000000000000009000000001000000900000000100089000000700000004303232319101000700000004010203009286000700000012000000cca00000070000000430313030a00100030000000100010000a00200040000000100000094a00300040000000100000046a4060003000000010000000000000000415343494900000053637265656e73686f740000ffe20d144943435f50524f46494c4500010100000d046170706c021000006d6e74725247422058595a2007e800010001001100310009616373704150504c000000004150504c000000000000000000000000000000000000f6d6000100000000d32d6170706c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000116465736300000150000000626473636d000001b4000001e063707274000003940000002377747074000003b8000000147258595a000003cc000000146758595a000003e0000000146258595a000003f40000001472545243000004080000080c6161726700000c14000000207663677400000c34000000306e64696e00000c640000003e6d6d6f6400000ca4000000287663677000000ccc0000003862545243000004080000080c67545243000004080000080c6161626700000c14000000206161676700000c1400000020646573630000000000000008446973706c61790000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006d6c756300000000000000260000000c6872485200000008000001d86b6f4b5200000008000001d86e624e4f00000008000001d86964000000000008000001d86875485500000008000001d86373435a00000008000001d86461444b00000008000001d86e6c4e4c00000008000001d86669464900000008000001d86974495400000008000001d86573455300000008000001d8726f524f00000008000001d86672434100000008000001d86172000000000008000001d8756b554100000008000001d86865494c00000008000001d87a68545700000008000001d87669564e00000008000001d8736b534b00000008000001d87a68434e00000008000001d87275525500000008000001d8656e474200000008000001d86672465200000008000001d86d73000000000008000001d86869494e00000008000001d87468544800000008000001d86361455300000008000001d8656e415500000008000001d86573584c00000008000001d86465444500000008000001d8656e555300000008000001d87074425200000008000001d8706c504c00000008000001d8656c475200000008000001d87376534500000008000001d87472545200000008000001d87074505400000008000001d86a614a5000000008000001d80069004d006100637465787400000000436f70797269676874204170706c6520496e632e2c2032303234000058595a20000000000000f31600010000000116ca58595a2000000000000082ca00003cb7fffffffe58595a200000000000004c4a0000b4df00000aeb58595a2000000000000027c200000e6b0000c84463757276000000000000040000000005000a000f00140019001e00230028002d00320036003b00400045004a004f00540059005e00630068006d00720077007c00810086008b00900095009a009f00a300a800ad00b200b700bc00c100c600cb00d000d500db00e000e500eb00f000f600fb01010107010d01130119011f0125012b01320138013e0145014c0152015901600167016e0175017c0183018b0192019a01a101a901b101b901c101c901d101d901e101e901f201fa0203020c0214021d0226022f02380241024b0254025d02670271027a0284028e029802a202ac02b602c102cb02d502e002eb02f50300030b03160321032d03380343034f035a03660372037e038a039603a203ae03ba03c703d303e003ec03f9040604130420042d043b0448045504630471047e048c049a04a804b604c404d304e104f004fe050d051c052b053a05490558056705770586059605a605b505c505d505e505f6060606160627063706480659066a067b068c069d06af06c006d106e306f507070719072b073d074f076107740786079907ac07bf07d207e507f8080b081f08320846085a086e0882089608aa08be08d208e708fb09100925093a094f09640979098f09a409ba09cf09e509fb0a110a270a3d0a540a6a0a810a980aae0ac50adc0af30b0b0b220b390b510b690b800b980bb00bc80be10bf90c120c2a0c430c5c0c750c8e0ca70cc00cd90cf30d0d0d260d400d5a0d740d8e0da90dc30dde0df80e130e2e0e490e640e7f0e9b0eb60ed20eee0f090f250f410f5e0f7a0f960fb30fcf0fec1009102610431061107e109b10b910d710f511131131114f116d118c11aa11c911e81207122612451264128412a312c312e31303132313431363138313a413c513e5140614271449146a148b14ad14ce14f01512153415561578159b15bd15e0160316261649166c168f16b216d616fa171d17411765178917ae17d217f7181b18401865188a18af18d518fa19201945196b199119b719dd1a041a2a1a511a771a9e1ac51aec1b141b3b1b631b8a1bb21bda1c021c2a1c521c7b1ca31ccc1cf51d1e1d471d701d991dc31dec1e161e401e6a1e941ebe1ee91f131f3e1f691f941fbf1fea20152041206c209820c420f0211c2148217521a121ce21fb22272255228222af22dd230a23382366239423c223f0241f244d247c24ab24da250925382568259725c725f726272657268726b726e827182749277a27ab27dc280d283f287128a228d429062938296b299d29d02a022a352a682a9b2acf2b022b362b692b9d2bd12c052c392c6e2ca22cd72d0c2d412d762dab2de12e162e4c2e822eb72eee2f242f5a2f912fc72ffe3035306c30a430db3112314a318231ba31f2322a3263329b32d4330d3346337f33b833f1342b3465349e34d83513354d358735c235fd3637367236ae36e937243760379c37d738143850388c38c839053942397f39bc39f93a363a743ab23aef3b2d3b6b3baa3be83c273c653ca43ce33d223d613da13de03e203e603ea03ee03f213f613fa23fe24023406440a640e74129416a41ac41ee4230427242b542f7433a437d43c044034447448a44ce45124555459a45de4622466746ab46f04735477b47c04805484b489148d7491d496349a949f04a374a7d4ac44b0c4b534b9a4be24c2a4c724cba4d024d4a4d934ddc4e254e6e4eb74f004f494f934fdd5027507150bb51065150519b51e65231527c52c75313535f53aa53f65442548f54db5528557555c2560f565c56a956f75744579257e0582f587d58cb591a596959b85a075a565aa65af55b455b955be55c355c865cd65d275d785dc95e1a5e6c5ebd5f0f5f615fb36005605760aa60fc614f61a261f56249629c62f06343639763eb6440649464e9653d659265e7663d669266e8673d679367e9683f689668ec6943699a69f16a486a9f6af76b4f6ba76bff6c576caf6d086d606db96e126e6b6ec46f1e6f786fd1702b708670e0713a719571f0724b72a67301735d73b87414747074cc7528758575e1763e769b76f8775677b37811786e78cc792a798979e77a467aa57b047b637bc27c217c817ce17d417da17e017e627ec27f237f847fe5804780a8810a816b81cd8230829282f4835783ba841d848084e3854785ab860e867286d7873b879f8804886988ce8933899989fe8a648aca8b308b968bfc8c638cca8d318d988dff8e668ece8f368f9e9006906e90d6913f91a89211927a92e3934d93b69420948a94f4955f95c99634969f970a977597e0984c98b89924999099fc9a689ad59b429baf9c1c9c899cf79d649dd29e409eae9f1d9f8b9ffaa069a0d8a147a1b6a226a296a306a376a3e6a456a4c7a538a5a9a61aa68ba6fda76ea7e0a852a8c4a937a9a9aa1caa8fab02ab75abe9ac5cacd0ad44adb8ae2daea1af16af8bb000b075b0eab160b1d6b24bb2c2b338b3aeb425b49cb513b58ab601b679b6f0b768b7e0b859b8d1b94ab9c2ba3bbab5bb2ebba7bc21bc9bbd15bd8fbe0abe84beffbf7abff5c070c0ecc167c1e3c25fc2dbc358c3d4c451c4cec54bc5c8c646c6c3c741c7bfc83dc8bcc93ac9b9ca38cab7cb36cbb6cc35ccb5cd35cdb5ce36ceb6cf37cfb8d039d0bad13cd1bed23fd2c1d344d3c6d449d4cbd54ed5d1d655d6d8d75cd7e0d864d8e8d96cd9f1da76dafbdb80dc05dc8add10dd96de1cdea2df29dfafe036e0bde144e1cce253e2dbe363e3ebe473e4fce584e60de696e71fe7a9e832e8bce946e9d0ea5beae5eb70ebfbec86ed11ed9cee28eeb4ef40efccf058f0e5f172f1fff28cf319f3a7f434f4c2f550f5def66df6fbf78af819f8a8f938f9c7fa57fae7fb77fc07fc98fd29fdbafe4bfedcff6dffff706172610000000000030000000266660000f2a700000d59000013d000000a5b7663677400000000000000010001000000000000000100000001000000000000000100000001000000000000000100006e64696e00000000000000360000ae4000005140000043c00000b0c00000268000000d80000050000000544000023333300023333300233333000000000000000006d6d6f6400000000000006100000ae1f50e5a070d478cfdd000000000000000000000000000000007663677000000000000300000002666600030000000266660003000000026666000000023333340000000002333334000000000233333400ffc00011080046009403012200021101031101ffc4001f0000010501010101010100000000000000000102030405060708090a0bffc400b5100002010303020403050504040000017d01020300041105122131410613516107227114328191a1082342b1c11552d1f02433627282090a161718191a25262728292a3435363738393a434445464748494a535455565758595a636465666768696a737475767778797a838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae1e2e3e4e5e6e7e8e9eaf1f2f3f4f5f6f7f8f9faffc4001f0100030101010101010101010000000000000102030405060708090a0bffc400b51100020102040403040705040400010277000102031104052131061241510761711322328108144291a1b1c109233352f0156272d10a162434e125f11718191a262728292a35363738393a434445464748494a535455565758595a636465666768696a737475767778797a82838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae2e3e4e5e6e7e8e9eaf2f3f4f5f6f7f8f9faffdb0043001c1c1c1c1c1c301c1c3044303030445c444444445c745c5c5c5c5c748c7474747474748c8c8c8c8c8c8c8ca8a8a8a8a8a8c4c4c4c4c4dcdcdcdcdcdcdcdcdcdcffdb00430122242438343860343460e69c809ce6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6ffdd0004000affda000c03010002110311003f00e928a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a00ffd0e928a28a0028a4240193c01598dac5886c6e247a8071401a9512cf0bb98d1d59875008c8c551b2bd9ef1cb795b61c1c313c920d7385a686f66ba879f2a439fa126803b6a89e786260b23aa93d0120669a97313db8b907e4c6ecd71f3c92dcdc25db8c2c8f85fa291fe3401dabba46a5e460aa3b9e0541f6db3ff009ec9ff007d0aabac7fc83e4ff80ff3155acb4cb29ad239248f2ccb92727fc6803691d241ba360c3d41cd41f6db3ff9ec9ff7d0ac258bec1ab2436ec76498c8fae7f975ab977a658c76d2c891e195490727ae3eb401a1f6db3ff9ec9ff7d0a95a7851048eea15ba12460d61699a7d9dc5a09664dcc49e7247f234fd6d163b28a3418556000f600d006b0bdb33c0993fefa1561595c6e52083dc565269360f12931f240e727fc6b3668a4d1a759a062d0b9c153fcbfc2803a8a2914860197907914b40051451401fffd1e928a28a00a3a9a48f632ac7c9c76f4cf354aceef4f4d3d51d946170ca7a93df8ef9ab7aab05b1932db32303dfdbf1ac4b78ee846ae2ca3718e091c9f7393fd28034743575b462dc2b312bf4c0a834d4592f2f11c65589047e26af58df8b976b778fca9107ddf6aafa6c52c77b72ee8ca198e09180793d280330db5e24a74b5cf94cdbb38edfe7f5ab5ab46909b48a31855240ff00c76ba4ac3d5e196596dcc68cc158e7009c74a00b3ac7fc83e4ff0080ff003159d6b06aed6c860991508e01eb8ffbe6b4f554792c5d2352cc71c0193d454d60ac96712b82085e41e0d0062e9a025fbc77809b8ecc4e7f2fc2b6efbfe3ce6ff71bf95666a30ca97d05dc28cd8e1b6827a1f6f635a978acf692aa824942001f4a00a5a2ff00c782ff00bc7f9d43af7fc7aa7fbe3f91ab3a44724564a92295393c118350eb714b2db22c4a5c87ce1467b1a00d587fd527fba3f95646bcca2d154f52e31f91a62ea37ca8116cdf2063273fe14c4b3bcbf9d67bf1b117a27f9fd68036ed815b6895ba845cfe553514500145145007ffd2e928a28a00a77f69f6db730e7690720fb8aa49fdb51a88f113638dc7fc8fe55b345006658d8c90caf7572c1a57e0e3a015a745140051451400514514005145140051451400514514005145140051451401ffd3e928a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a00ffd9"

	var csca = utils.HexToBytes("308205FA308203E2A0030201020204492EAE16300D06092A864886F70D01010B05003041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479301E170D3130303332343134303230315A170D3236303732343134333230315A3041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F7269747930820222300D06092A864886F70D01010105000382020F003082020A0282020100C3583682D60EE9DB5E77F3CD27F02C8657ABA30C70A21EBC33FCAFA8E96B5806A090EF29CDC8A4A286F750C4F237CE89A207D460DED39854CFF2BA8F4E7807C655FE1B60E7459FF7E24DE2806EA6823BA8B3DD0A00C80B3DCB8BAE3C4620D9F5A81E3144E7805C96F147AFB13D6C9BAAB3D469EFCA9EADACAD81ED623FCCA82263D72350F553C17DE29352F937CA3EEFDAA902FE718EFC5F90CE9B35027E5F56CD92FDE396B2ACD2C8A83A7F5712CF7DF298607D072B8E82C5DD94BE323D293ADBD25B4F53467AAAE53E92BDD23E26B5501DA24B53E1F492917CA0FA8C59680FB17C952AC642944639B385A06315C251B204DD922E2F86A1D40F1FE3626E602D8D9ED0870C5D0E86ACB0E3845557E63CBB327D9EFFECD317A31FA337AEAC6F9304EB59B63DFEA4D7EC7AC94891D5D8B14F4FB4DB1AA4A88AD5B339FE7DCB460F8231F5B0628A6EA75C3FC252BF00C0D54D850D489346F3753A476A0EA237CAF9001CE729BB2EC2CEA6368F040A2B1B1108A2133EFFE4CA369D043D58A72D0AC1202138CCA1A370B26D576DA079DBDD6C59989F1E40F670AF27E28231ED3F7A5C7F1F699B9AB217F7125993CDA5C0B25147A0C37D08098B85D8B4F231303B1DF92EFAF03E31D92DE00D6971FD4D43971C318DCCB3F1FE908520F5AA788EADE562D0B23F85FF76340C5D181811B2C19529387807EBDD7C5AB09D971F0D3AB516AD0203010001A381F93081F6300E0603551D0F0101FF04040302010630120603551D130101FF040830060101FF02010030630603551D1F045C305A3058A056A054A4523050310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479310D300B0603550403130443524C31302B0603551D1004243022800F32303130303332343134303230315A810F32303236303732343134333230315A301F0603551D230418301680144531A5B73BCF8BB27C7FAC88C74B4505F6C936B3301D0603551D0E041604144531A5B73BCF8BB27C7FAC88C74B4505F6C936B3300D06092A864886F70D01010B0500038202010054F23F6A723698B06338E7A37FB2C740506E2175970C76E20D629D0AB5557359360826E7A611B3748470C1E7995952547C1BB790F4899D258F9127F6C4730F5FF63A8498EAEB50FAF767283B73325B968B497E8C6361073EC25DA7E4C225F36E5870D5874F11BC102F4DC2FEE784F3B3CB9AF3BD3C55F5A72C1883EB2632153B16F594AA086D549228CF0013199D66899181BE47AC0EF37D5F4FE7CB23B8565CD7F4099968DD90791E8EAAE871914BB25C4ABC5556D8387D4964CD87051088431FC32AAC31E37DCEE14BA835C9618E1365216BD227563D99520FD03B101CA7EABFE326BA71B4DE40DA328B2F65E99B591B01FC132C9713BF525238FEDE68A509653C196AA73404D970509D7112EFBC62F385F9642DDE0FBFC7228E0AB388C69E0304B617CC56E4B6253FBD005B22AFF67420F51069AE8D2DC9E5F076E33016AA4E1BBE11A3B79CBA4E41002021639126B7DDC79DC6DF2CD2C1DDB706B825125514F8E5797C409B1B69A8EADA1E95E1FAD139F7C1E189008A5BAB74DF7E87830AF1FBDFC27BD1985CF8DFE5C631AA4F7C0D439D80FB35B34F7722FC0EFBD2B88B4C4BC918EE4E5BD868EB49E1B6858696B364BCEC7D69E494E7DA8198D69A6ABE1F31D01502F5E78550808C2F14CD447E0E56ACDF01A5A145C52EC867232091F1C71800654CC7529557C3414667F9711275B36E92196DD8D600587D4E93FD08D3")

	data := models.PassportValidationRequest{
		DataGroups: map[string]string{
			"DG1": dg1Hex,
			"DG2": dg2Hex,
		},
		EFSOD: sodHex,
	}

	var trustedCerts cms.GenericCertPool
	err := trustedCerts.Add(csca)
	if err != nil {
		t.Fatalf("unexpected error (trustedCerts.Add): %s", err)
	}

	// Test that SOD can be parsed correctly and that passive auth works.
	_, err = PassiveAuthentication(data, &trustedCerts)
	require.NoError(t, err)

}

func TestPassiveAuthenticationIgnoresInvalidDG7(t *testing.T) {
	var sodHex = "778207853082078106092A864886F70D010702A08207723082076E020103310D300B0609608648016503040201306E0606678108010101A06404623060020100300B0609608648016503040201304E30250201010420CA34A2808CA60C6671EC66F4E1229ADF0474BF1A7E099A05946B999438D511AD302502010204205F03553723906ACBE6B68B52F639F73B9F9E3C3135BC87E6E3D511C922AC7D20A08204F8308204F4308202DCA0030201020204492EBA13300D06092A864886F70D01010B05003041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479301E170D3131303830313132353535335A170D3232313230313031323535335A304F310B3009060355040613026762310D300B060355040A1304756B7073310F300D060355040B13066C6F6E646F6E3120301E06035504031317446F63756D656E74205369676E696E67204B657920333530820122300D06092A864886F70D01010105000382010F003082010A0282010100CE65C9D95D8FADB3C2AEABAB99220F96B5880F69AE651B3A7A378E293099B343BD1CB58FD28F0FD2F0166EA05273ECA9A3BE315397A7C6951C3FD09DCFF864C5F4B763F89851C8F9632E63D819C9EC905B90DA9D78FE0376F7218FE4B51EE88C66ECED44F4F98FEDFDBDD920484DA7AEE39E199196895DDC2C58ECF16B72D6E84770DE10793434C42FE01B8E7FC5DB7C38D7ACDEC5C1476CF1E69152E9D31CAEC122AF71280078AE054509F1CFEFC1340797FDAFCEAE5B4CBA8EDC7AB391DE69649CF9A33CA2596718E887C948EEA60BD99AA0E80C88FF94FA6FB78EEFAE98F4EC2CACC201D7EED96126292A23C4F9452D5EFF66333CC6DBE3E2EEDC3EC360DF0203010001A381E53081E2302B0603551D1004243022800F32303131303830313133323535335A810F32303131313130333133323535335A300E0603551D0F0101FF04040302078030630603551D1F045C305A3058A056A054A4523050310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479310D300B0603550403130443524C34301F0603551D230418301680144531A5B73BCF8BB27C7FAC88C74B4505F6C936B3301D0603551D0E0416041467B8149943C5F8C949BC846A34DBE7E05D241404300D06092A864886F70D01010B050003820201005BFB66391196171815A26AE99FD1653B7F6C9FFB751BBD69ADEF0B4182C043C4726FD826C8011BF12DA9374A79963613672C84289671EC31D53CA73E23E0A119F884B5D5836CE1F9DD03787624ABBDFEF475F16D5BFFFD719DE0B0FD1C0FE9D0E8064C6F77372CBBB00E1E43715A157EFB5F3D97E60A5018B6F07E7C735067FC73480B393D8945D09ED79F3D9C3F6299B7F2A2FC5829ABCE927C23010FE74788AF2AC7D38A08075C4559E256ECF8CB62BC27316FB477A79653A836EC03032CFA2FDF009EE6C9B5A102C91C381C0B941952A22AF5DAF9552A8A7F70D1F5847C8D3762CC7A2C0B44CC12A74C6CB410985641979B4CAD092A199A7371716592B9BC0A8691B60D830E13E749B31FFE120E0E2C98E2DE1C745ED16D3D2DF7205DDDC34C1B06413C28C9DC11C1F03F3E0A20321D8ACC13183EE003CE36DCA354E8053145F6055451C3F6A2A8E40998C5EF40609E431894C524CA9A7523B8B3BD667BD09F1F9E0EAC7602E1B8758F82EE61DA953E9B188ADF5A382D23EE4137F50B0A7AE8833AF55D5F0DD9E6E5D71B2A2543FBFAA2F7902D8E1BD656B6654264E108792E70C68227CE7F58C5C866D5CCFD3572941F21CFC2AA85EAEC84B4C6988C75BEC1711F11149356DC40119F4B023154BCED5B581FD71FEC2BC106D737E8D1F9704C5686A182C0148CA90B93CA17DD2797FBA2619F69D3F8474BC9D9493A33F45A318201EC308201E802010130493041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F726974790204492EBA13300B0609608648016503040201A048301506092A864886F70D01090331080606678108010101302F06092A864886F70D010904312204206A2DFFE58D6A59A5AAE942C2BAF9A585B4B20E63C4B7ED0CE4B497FFC7F80992303D06092A864886F70D01010A3030A00D300B0609608648016503040201A11A301806092A864886F70D010108300B0609608648016503040201A203020120048201007465E8179610CC7D48D7F2AB0A88FD939E5CAB0D7226874F5647AA1A97911CF61DED88DA44D1AEC330C7045E3B5DFB7A79F19698C12D659BC37B8E98375D130ADEC2BD6688A57C996D9FC2DC8E0E2594BFA3E43E4FD7E63A7895435182D566F749C39FB4E948658E58769F871E665FA92C4C620DF2940DA028C72F2B05B4FA35E16201BD912AB7F6E4C07116E6086724C2009C2C29C2B83050546EE29CB162B975EF2A9718CDEC2737518D282CBA5B11A95707EA3DC915047A8906181B3E4FE823EA34A5C1BF7A93D5510EA8A7A355385C344E76647EF73AFF9270CC678D6DBAD06088C950E2BFC2DF382E48D765ACC6E4207E09457011AC72EBB4DBABB81611"
	var dg1Hex = "615B5F1F58503C47425253414E444552534F4E3C3C4F534341523C434841524C45533C4544574152443C3C3C3C3C3C3C3C30393932353036393236474252373830343035364D323230373137393C3C3C3C3C3C3C3C3C3C3C3C3C3C3032"
	var dg2Hex = "758214397f618214340201017f6082142ca10c8002010187020101880200085f2e82141946414300303130000000141900010000140b00000000000000000000000000000000020100940046000000000000ffd8ffe000104a46494600010201004800480000ffe100e84578696600004d4d002a000000080006011200030000000100010000011a00050000000100000056011b0005000000010000005e012800030000000100020000021300030000000100010000876900040000000100000066000000000000009000000001000000900000000100089000000700000004303232319101000700000004010203009286000700000012000000cca00000070000000430313030a00100030000000100010000a00200040000000100000094a00300040000000100000046a4060003000000010000000000000000415343494900000053637265656e73686f740000ffe20d144943435f50524f46494c4500010100000d046170706c021000006d6e74725247422058595a2007e800010001001100310009616373704150504c000000004150504c000000000000000000000000000000000000f6d6000100000000d32d6170706c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000116465736300000150000000626473636d000001b4000001e063707274000003940000002377747074000003b8000000147258595a000003cc000000146758595a000003e0000000146258595a000003f40000001472545243000004080000080c6161726700000c14000000207663677400000c34000000306e64696e00000c640000003e6d6d6f6400000ca4000000287663677000000ccc0000003862545243000004080000080c67545243000004080000080c6161626700000c14000000206161676700000c1400000020646573630000000000000008446973706c61790000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006d6c756300000000000000260000000c6872485200000008000001d86b6f4b5200000008000001d86e624e4f00000008000001d86964000000000008000001d86875485500000008000001d86373435a00000008000001d86461444b00000008000001d86e6c4e4c00000008000001d86669464900000008000001d86974495400000008000001d86573455300000008000001d8726f524f00000008000001d86672434100000008000001d86172000000000008000001d8756b554100000008000001d86865494c00000008000001d87a68545700000008000001d87669564e00000008000001d8736b534b00000008000001d87a68434e00000008000001d87275525500000008000001d8656e474200000008000001d86672465200000008000001d86d73000000000008000001d86869494e00000008000001d87468544800000008000001d86361455300000008000001d8656e415500000008000001d86573584c00000008000001d86465444500000008000001d8656e555300000008000001d87074425200000008000001d8706c504c00000008000001d8656c475200000008000001d87376534500000008000001d87472545200000008000001d87074505400000008000001d86a614a5000000008000001d80069004d006100637465787400000000436f70797269676874204170706c6520496e632e2c2032303234000058595a20000000000000f31600010000000116ca58595a2000000000000082ca00003cb7fffffffe58595a200000000000004c4a0000b4df00000aeb58595a2000000000000027c200000e6b0000c84463757276000000000000040000000005000a000f00140019001e00230028002d00320036003b00400045004a004f00540059005e00630068006d00720077007c00810086008b00900095009a009f00a300a800ad00b200b700bc00c100c600cb00d000d500db00e000e500eb00f000f600fb01010107010d01130119011f0125012b01320138013e0145014c0152015901600167016e0175017c0183018b0192019a01a101a901b101b901c101c901d101d901e101e901f201fa0203020c0214021d0226022f02380241024b0254025d02670271027a0284028e029802a202ac02b602c102cb02d502e002eb02f50300030b03160321032d03380343034f035a03660372037e038a039603a203ae03ba03c703d303e003ec03f9040604130420042d043b0448045504630471047e048c049a04a804b604c404d304e104f004fe050d051c052b053a05490558056705770586059605a605b505c505d505e505f6060606160627063706480659066a067b068c069d06af06c006d106e306f507070719072b073d074f076107740786079907ac07bf07d207e507f8080b081f08320846085a086e0882089608aa08be08d208e708fb09100925093a094f09640979098f09a409ba09cf09e509fb0a110a270a3d0a540a6a0a810a980aae0ac50adc0af30b0b0b220b390b510b690b800b980bb00bc80be10bf90c120c2a0c430c5c0c750c8e0ca70cc00cd90cf30d0d0d260d400d5a0d740d8e0da90dc30dde0df80e130e2e0e490e640e7f0e9b0eb60ed20eee0f090f250f410f5e0f7a0f960fb30fcf0fec1009102610431061107e109b10b910d710f511131131114f116d118c11aa11c911e81207122612451264128412a312c312e31303132313431363138313a413c513e5140614271449146a148b14ad14ce14f01512153415561578159b15bd15e0160316261649166c168f16b216d616fa171d17411765178917ae17d217f7181b18401865188a18af18d518fa19201945196b199119b719dd1a041a2a1a511a771a9e1ac51aec1b141b3b1b631b8a1bb21bda1c021c2a1c521c7b1ca31ccc1cf51d1e1d471d701d991dc31dec1e161e401e6a1e941ebe1ee91f131f3e1f691f941fbf1fea20152041206c209820c420f0211c2148217521a121ce21fb22272255228222af22dd230a23382366239423c223f0241f244d247c24ab24da250925382568259725c725f726272657268726b726e827182749277a27ab27dc280d283f287128a228d429062938296b299d29d02a022a352a682a9b2acf2b022b362b692b9d2bd12c052c392c6e2ca22cd72d0c2d412d762dab2de12e162e4c2e822eb72eee2f242f5a2f912fc72ffe3035306c30a430db3112314a318231ba31f2322a3263329b32d4330d3346337f33b833f1342b3465349e34d83513354d358735c235fd3637367236ae36e937243760379c37d738143850388c38c839053942397f39bc39f93a363a743ab23aef3b2d3b6b3baa3be83c273c653ca43ce33d223d613da13de03e203e603ea03ee03f213f613fa23fe24023406440a640e74129416a41ac41ee4230427242b542f7433a437d43c044034447448a44ce45124555459a45de4622466746ab46f04735477b47c04805484b489148d7491d496349a949f04a374a7d4ac44b0c4b534b9a4be24c2a4c724cba4d024d4a4d934ddc4e254e6e4eb74f004f494f934fdd5027507150bb51065150519b51e65231527c52c75313535f53aa53f65442548f54db5528557555c2560f565c56a956f75744579257e0582f587d58cb591a596959b85a075a565aa65af55b455b955be55c355c865cd65d275d785dc95e1a5e6c5ebd5f0f5f615fb36005605760aa60fc614f61a261f56249629c62f06343639763eb6440649464e9653d659265e7663d669266e8673d679367e9683f689668ec6943699a69f16a486a9f6af76b4f6ba76bff6c576caf6d086d606db96e126e6b6ec46f1e6f786fd1702b708670e0713a719571f0724b72a67301735d73b87414747074cc7528758575e1763e769b76f8775677b37811786e78cc792a798979e77a467aa57b047b637bc27c217c817ce17d417da17e017e627ec27f237f847fe5804780a8810a816b81cd8230829282f4835783ba841d848084e3854785ab860e867286d7873b879f8804886988ce8933899989fe8a648aca8b308b968bfc8c638cca8d318d988dff8e668ece8f368f9e9006906e90d6913f91a89211927a92e3934d93b69420948a94f4955f95c99634969f970a977597e0984c98b89924999099fc9a689ad59b429baf9c1c9c899cf79d649dd29e409eae9f1d9f8b9ffaa069a0d8a147a1b6a226a296a306a376a3e6a456a4c7a538a5a9a61aa68ba6fda76ea7e0a852a8c4a937a9a9aa1caa8fab02ab75abe9ac5cacd0ad44adb8ae2daea1af16af8bb000b075b0eab160b1d6b24bb2c2b338b3aeb425b49cb513b58ab601b679b6f0b768b7e0b859b8d1b94ab9c2ba3bbab5bb2ebba7bc21bc9bbd15bd8fbe0abe84beffbf7abff5c070c0ecc167c1e3c25fc2dbc358c3d4c451c4cec54bc5c8c646c6c3c741c7bfc83dc8bcc93ac9b9ca38cab7cb36cbb6cc35ccb5cd35cdb5ce36ceb6cf37cfb8d039d0bad13cd1bed23fd2c1d344d3c6d449d4cbd54ed5d1d655d6d8d75cd7e0d864d8e8d96cd9f1da76dafbdb80dc05dc8add10dd96de1cdea2df29dfafe036e0bde144e1cce253e2dbe363e3ebe473e4fce584e60de696e71fe7a9e832e8bce946e9d0ea5beae5eb70ebfbec86ed11ed9cee28eeb4ef40efccf058f0e5f172f1fff28cf319f3a7f434f4c2f550f5def66df6fbf78af819f8a8f938f9c7fa57fae7fb77fc07fc98fd29fdbafe4bfedcff6dffff706172610000000000030000000266660000f2a700000d59000013d000000a5b7663677400000000000000010001000000000000000100000001000000000000000100000001000000000000000100006e64696e00000000000000360000ae4000005140000043c00000b0c00000268000000d80000050000000544000023333300023333300233333000000000000000006d6d6f6400000000000006100000ae1f50e5a070d478cfdd000000000000000000000000000000007663677000000000000300000002666600030000000266660003000000026666000000023333340000000002333334000000000233333400ffc00011080046009403012200021101031101ffc4001f0000010501010101010100000000000000000102030405060708090a0bffc400b5100002010303020403050504040000017d01020300041105122131410613516107227114328191a1082342b1c11552d1f02433627282090a161718191a25262728292a3435363738393a434445464748494a535455565758595a636465666768696a737475767778797a838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae1e2e3e4e5e6e7e8e9eaf1f2f3f4f5f6f7f8f9faffc4001f0100030101010101010101010000000000000102030405060708090a0bffc400b51100020102040403040705040400010277000102031104052131061241510761711322328108144291a1b1c109233352f0156272d10a162434e125f11718191a262728292a35363738393a434445464748494a535455565758595a636465666768696a737475767778797a82838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae2e3e4e5e6e7e8e9eaf2f3f4f5f6f7f8f9faffdb0043001c1c1c1c1c1c301c1c3044303030445c444444445c745c5c5c5c5c748c7474747474748c8c8c8c8c8c8c8ca8a8a8a8a8a8c4c4c4c4c4dcdcdcdcdcdcdcdcdcdcffdb00430122242438343860343460e69c809ce6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6ffdd0004000affda000c03010002110311003f00e928a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a00ffd0e928a28a0028a4240193c01598dac5886c6e247a8071401a9512cf0bb98d1d59875008c8c551b2bd9ef1cb795b61c1c313c920d7385a686f66ba879f2a439fa126803b6a89e786260b23aa93d0120669a97313db8b907e4c6ecd71f3c92dcdc25db8c2c8f85fa291fe3401dabba46a5e460aa3b9e0541f6db3ff009ec9ff007d0aabac7fc83e4ff80ff3155acb4cb29ad239248f2ccb92727fc6803691d241ba360c3d41cd41f6db3ff9ec9ff7d0ac258bec1ab2436ec76498c8fae7f975ab977a658c76d2c891e195490727ae3eb401a1f6db3ff9ec9ff7d0a95a7851048eea15ba12460d61699a7d9dc5a09664dcc49e7247f234fd6d163b28a3418556000f600d006b0bdb33c0993fefa1561595c6e52083dc565269360f12931f240e727fc6b3668a4d1a759a062d0b9c153fcbfc2803a8a2914860197907914b40051451401fffd1e928a28a00a3a9a48f632ac7c9c76f4cf354aceef4f4d3d51d946170ca7a93df8ef9ab7aab05b1932db32303dfdbf1ac4b78ee846ae2ca3718e091c9f7393fd28034743575b462dc2b312bf4c0a834d4592f2f11c65589047e26af58df8b976b778fca9107ddf6aafa6c52c77b72ee8ca198e09180793d280330db5e24a74b5cf94cdbb38edfe7f5ab5ab46909b48a31855240ff00c76ba4ac3d5e196596dcc68cc158e7009c74a00b3ac7fc83e4ff0080ff003159d6b06aed6c860991508e01eb8ffbe6b4f554792c5d2352cc71c0193d454d60ac96712b82085e41e0d0062e9a025fbc77809b8ecc4e7f2fc2b6efbfe3ce6ff71bf95666a30ca97d05dc28cd8e1b6827a1f6f635a978acf692aa824942001f4a00a5a2ff00c782ff00bc7f9d43af7fc7aa7fbe3f91ab3a44724564a92295393c118350eb714b2db22c4a5c87ce1467b1a00d587fd527fba3f95646bcca2d154f52e31f91a62ea37ca8116cdf2063273fe14c4b3bcbf9d67bf1b117a27f9fd68036ed815b6895ba845cfe553514500145145007ffd2e928a28a00a77f69f6db730e7690720fb8aa49fdb51a88f113638dc7fc8fe55b345006658d8c90caf7572c1a57e0e3a015a745140051451400514514005145140051451400514514005145140051451401ffd3e928a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a00ffd9"
	var invalidDG7Hex = "00"

	var csca = utils.HexToBytes("308205FA308203E2A0030201020204492EAE16300D06092A864886F70D01010B05003041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479301E170D3130303332343134303230315A170D3236303732343134333230315A3041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F7269747930820222300D06092A864886F70D01010105000382020F003082020A0282020100C3583682D60EE9DB5E77F3CD27F02C8657ABA30C70A21EBC33FCAFA8E96B5806A090EF29CDC8A4A286F750C4F237CE89A207D460DED39854CFF2BA8F4E7807C655FE1B60E7459FF7E24DE2806EA6823BA8B3DD0A00C80B3DCB8BAE3C4620D9F5A81E3144E7805C96F147AFB13D6C9BAAB3D469EFCA9EADACAD81ED623FCCA82263D72350F553C17DE29352F937CA3EEFDAA902FE718EFC5F90CE9B35027E5F56CD92FDE396B2ACD2C8A83A7F5712CF7DF298607D072B8E82C5DD94BE323D293ADBD25B4F53467AAAE53E92BDD23E26B5501DA24B53E1F492917CA0FA8C59680FB17C952AC642944639B385A06315C251B204DD922E2F86A1D40F1FE3626E602D8D9ED0870C5D0E86ACB0E3845557E63CBB327D9EFFECD317A31FA337AEAC6F9304EB59B63DFEA4D7EC7AC94891D5D8B14F4FB4DB1AA4A88AD5B339FE7DCB460F8231F5B0628A6EA75C3FC252BF00C0D54D850D489346F3753A476A0EA237CAF9001CE729BB2EC2CEA6368F040A2B1B1108A2133EFFE4CA369D043D58A72D0AC1202138CCA1A370B26D576DA079DBDD6C59989F1E40F670AF27E28231ED3F7A5C7F1F699B9AB217F7125993CDA5C0B25147A0C37D08098B85D8B4F231303B1DF92EFAF03E31D92DE00D6971FD4D43971C318DCCB3F1FE908520F5AA788EADE562D0B23F85FF76340C5D181811B2C19529387807EBDD7C5AB09D971F0D3AB516AD0203010001A381F93081F6300E0603551D0F0101FF04040302010630120603551D130101FF040830060101FF02010030630603551D1F045C305A3058A056A054A4523050310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479310D300B0603550403130443524C31302B0603551D1004243022800F32303130303332343134303230315A810F32303236303732343134333230315A301F0603551D230418301680144531A5B73BCF8BB27C7FAC88C74B4505F6C936B3301D0603551D0E041604144531A5B73BCF8BB27C7FAC88C74B4505F6C936B3300D06092A864886F70D01010B0500038202010054F23F6A723698B06338E7A37FB2C740506E2175970C76E20D629D0AB5557359360826E7A611B3748470C1E7995952547C1BB790F4899D258F9127F6C4730F5FF63A8498EAEB50FAF767283B73325B968B497E8C6361073EC25DA7E4C225F36E5870D5874F11BC102F4DC2FEE784F3B3CB9AF3BD3C55F5A72C1883EB2632153B16F594AA086D549228CF0013199D66899181BE47AC0EF37D5F4FE7CB23B8565CD7F4099968DD90791E8EAAE871914BB25C4ABC5556D8387D4964CD87051088431FC32AAC31E37DCEE14BA835C9618E1365216BD227563D99520FD03B101CA7EABFE326BA71B4DE40DA328B2F65E99B591B01FC132C9713BF525238FEDE68A509653C196AA73404D970509D7112EFBC62F385F9642DDE0FBFC7228E0AB388C69E0304B617CC56E4B6253FBD005B22AFF67420F51069AE8D2DC9E5F076E33016AA4E1BBE11A3B79CBA4E41002021639126B7DDC79DC6DF2CD2C1DDB706B825125514F8E5797C409B1B69A8EADA1E95E1FAD139F7C1E189008A5BAB74DF7E87830AF1FBDFC27BD1985CF8DFE5C631AA4F7C0D439D80FB35B34F7722FC0EFBD2B88B4C4BC918EE4E5BD868EB49E1B6858696B364BCEC7D69E494E7DA8198D69A6ABE1F31D01502F5E78550808C2F14CD447E0E56ACDF01A5A145C52EC867232091F1C71800654CC7529557C3414667F9711275B36E92196DD8D600587D4E93FD08D3")

	data := models.PassportValidationRequest{
		DataGroups: map[string]string{
			"DG1": dg1Hex,
			"DG2": dg2Hex,
			"DG7": invalidDG7Hex,
		},
		EFSOD: sodHex,
	}

	var trustedCerts cms.GenericCertPool
	err := trustedCerts.Add(csca)
	if err != nil {
		t.Fatalf("unexpected error (trustedCerts.Add): %s", err)
	}

	doc, err := PassiveAuthentication(data, &trustedCerts)
	require.NoError(t, err)
	require.Nil(t, doc.Mf.Lds1.Dg7)
}

func TestActiveAuthentication(t *testing.T) {
	tests := []struct {
		name      string
		nonce     string
		signature string
	}{
		{
			name:      "missing nonce returns false with no error",
			nonce:     "",
			signature: "signature",
		},
		{
			name:      "missing signature returns false with no error",
			nonce:     "nonce",
			signature: "",
		},
		{
			name:      "missing DG15 returns false with no error",
			nonce:     "nonce",
			signature: "signature",
		},
		{
			name:      "all missing returns false with no error",
			nonce:     "",
			signature: "",
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			data := models.PassportValidationRequest{
				Nonce:               tt.nonce,
				ActiveAuthSignature: tt.signature,
			}
			doc := document.Document{}
			result, err := ActiveAuthentication(data, doc)
			require.NoError(t, err)
			require.False(t, result)
		})
	}
}

func TestActiveAuthentication_InvalidSignature(t *testing.T) {
	// Test with DG15 present but invalid signature
	var dg15Hex = "6F81A130819E300D06092A864886F70D010101050003818C00308188028180CF9A8BA6EAD230E592AA6B5DA04558CC005A5291B295418575D68D637F41AF105813293D1D43F3685F014FFF3007730E6A15B7801558C6911F1084B7B8553BEE577F84EA7B8BF346128DA380D57E500FAF5AB70971DD9B25F387343E0B6CFA1316B3F58F6B9D3E93A72DD6BE3C7A79D960CE8CBAF8726F5E4FBF289287941FD70203010001"
	dg15Bytes := utils.HexToBytes(dg15Hex)
	dg15, err := document.NewDG15(dg15Bytes)
	require.NoError(t, err)

	doc := document.Document{}
	doc.Mf.Lds1.Dg15 = dg15

	data := models.PassportValidationRequest{
		Nonce:               "AABBCCDD",
		ActiveAuthSignature: "DEADBEEF",
	}

	result, err := ActiveAuthentication(data, doc)
	require.Error(t, err)
	require.False(t, result)
	require.Contains(t, err.Error(), "failed to validate active authentication signature")
}

func TestPassiveAuthenticationIgnoresInvalidOptionalDataGroups(t *testing.T) {
	// Test data from gmrtd test cases (expired UK passport)
	var sodHex = "778207853082078106092A864886F70D010702A08207723082076E020103310D300B0609608648016503040201306E0606678108010101A06404623060020100300B0609608648016503040201304E30250201010420CA34A2808CA60C6671EC66F4E1229ADF0474BF1A7E099A05946B999438D511AD302502010204205F03553723906ACBE6B68B52F639F73B9F9E3C3135BC87E6E3D511C922AC7D20A08204F8308204F4308202DCA0030201020204492EBA13300D06092A864886F70D01010B05003041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479301E170D3131303830313132353535335A170D3232313230313031323535335A304F310B3009060355040613026762310D300B060355040A1304756B7073310F300D060355040B13066C6F6E646F6E3120301E06035504031317446F63756D656E74205369676E696E67204B657920333530820122300D06092A864886F70D01010105000382010F003082010A0282010100CE65C9D95D8FADB3C2AEABAB99220F96B5880F69AE651B3A7A378E293099B343BD1CB58FD28F0FD2F0166EA05273ECA9A3BE315397A7C6951C3FD09DCFF864C5F4B763F89851C8F9632E63D819C9EC905B90DA9D78FE0376F7218FE4B51EE88C66ECED44F4F98FEDFDBDD920484DA7AEE39E199196895DDC2C58ECF16B72D6E84770DE10793434C42FE01B8E7FC5DB7C38D7ACDEC5C1476CF1E69152E9D31CAEC122AF71280078AE054509F1CFEFC1340797FDAFCEAE5B4CBA8EDC7AB391DE69649CF9A33CA2596718E887C948EEA60BD99AA0E80C88FF94FA6FB78EEFAE98F4EC2CACC201D7EED96126292A23C4F9452D5EFF66333CC6DBE3E2EEDC3EC360DF0203010001A381E53081E2302B0603551D1004243022800F32303131303830313133323535335A810F32303131313130333133323535335A300E0603551D0F0101FF04040302078030630603551D1F045C305A3058A056A054A4523050310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479310D300B0603550403130443524C34301F0603551D230418301680144531A5B73BCF8BB27C7FAC88C74B4505F6C936B3301D0603551D0E0416041467B8149943C5F8C949BC846A34DBE7E05D241404300D06092A864886F70D01010B050003820201005BFB66391196171815A26AE99FD1653B7F6C9FFB751BBD69ADEF0B4182C043C4726FD826C8011BF12DA9374A79963613672C84289671EC31D53CA73E23E0A119F884B5D5836CE1F9DD03787624ABBDFEF475F16D5BFFFD719DE0B0FD1C0FE9D0E8064C6F77372CBBB00E1E43715A157EFB5F3D97E60A5018B6F07E7C735067FC73480B393D8945D09ED79F3D9C3F6299B7F2A2FC5829ABCE927C23010FE74788AF2AC7D38A08075C4559E256ECF8CB62BC27316FB477A79653A836EC03032CFA2FDF009EE6C9B5A102C91C381C0B941952A22AF5DAF9552A8A7F70D1F5847C8D3762CC7A2C0B44CC12A74C6CB410985641979B4CAD092A199A7371716592B9BC0A8691B60D830E13E749B31FFE120E0E2C98E2DE1C745ED16D3D2DF7205DDDC34C1B06413C28C9DC11C1F03F3E0A20321D8ACC13183EE003CE36DCA354E8053145F6055451C3F6A2A8E40998C5EF40609E431894C524CA9A7523B8B3BD667BD09F1F9E0EAC7602E1B8758F82EE61DA953E9B188ADF5A382D23EE4137F50B0A7AE8833AF55D5F0DD9E6E5D71B2A2543FBFAA2F7902D8E1BD656B6654264E108792E70C68227CE7F58C5C866D5CCFD3572941F21CFC2AA85EAEC84B4C6988C75BEC1711F11149356DC40119F4B023154BCED5B581FD71FEC2BC106D737E8D1F9704C5686A182C0148CA90B93CA17DD2797FBA2619F69D3F8474BC9D9493A33F45A318201EC308201E802010130493041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F726974790204492EBA13300B0609608648016503040201A048301506092A864886F70D01090331080606678108010101302F06092A864886F70D010904312204206A2DFFE58D6A59A5AAE942C2BAF9A585B4B20E63C4B7ED0CE4B497FFC7F80992303D06092A864886F70D01010A3030A00D300B0609608648016503040201A11A301806092A864886F70D010108300B0609608648016503040201A203020120048201007465E8179610CC7D48D7F2AB0A88FD939E5CAB0D7226874F5647AA1A97911CF61DED88DA44D1AEC330C7045E3B5DFB7A79F19698C12D659BC37B8E98375D130ADEC2BD6688A57C996D9FC2DC8E0E2594BFA3E43E4FD7E63A7895435182D566F749C39FB4E948658E58769F871E665FA92C4C620DF2940DA028C72F2B05B4FA35E16201BD912AB7F6E4C07116E6086724C2009C2C29C2B83050546EE29CB162B975EF2A9718CDEC2737518D282CBA5B11A95707EA3DC915047A8906181B3E4FE823EA34A5C1BF7A93D5510EA8A7A355385C344E76647EF73AFF9270CC678D6DBAD06088C950E2BFC2DF382E48D765ACC6E4207E09457011AC72EBB4DBABB81611"
	var dg1Hex = "615B5F1F58503C47425253414E444552534F4E3C3C4F534341523C434841524C45533C4544574152443C3C3C3C3C3C3C3C30393932353036393236474252373830343035364D323230373137393C3C3C3C3C3C3C3C3C3C3C3C3C3C3032"
	var dg2Hex = "758214397f618214340201017f6082142ca10c8002010187020101880200085f2e82141946414300303130000000141900010000140b00000000000000000000000000000000020100940046000000000000ffd8ffe000104a46494600010201004800480000ffe100e84578696600004d4d002a000000080006011200030000000100010000011a00050000000100000056011b0005000000010000005e012800030000000100020000021300030000000100010000876900040000000100000066000000000000009000000001000000900000000100089000000700000004303232319101000700000004010203009286000700000012000000cca00000070000000430313030a00100030000000100010000a00200040000000100000094a00300040000000100000046a4060003000000010000000000000000415343494900000053637265656e73686f740000ffe20d144943435f50524f46494c4500010100000d046170706c021000006d6e74725247422058595a2007e800010001001100310009616373704150504c000000004150504c000000000000000000000000000000000000f6d6000100000000d32d6170706c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000116465736300000150000000626473636d000001b4000001e063707274000003940000002377747074000003b8000000147258595a000003cc000000146758595a000003e0000000146258595a000003f40000001472545243000004080000080c6161726700000c14000000207663677400000c34000000306e64696e00000c640000003e6d6d6f6400000ca4000000287663677000000ccc0000003862545243000004080000080c67545243000004080000080c6161626700000c14000000206161676700000c1400000020646573630000000000000008446973706c61790000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006d6c756300000000000000260000000c6872485200000008000001d86b6f4b5200000008000001d86e624e4f00000008000001d86964000000000008000001d86875485500000008000001d86373435a00000008000001d86461444b00000008000001d86e6c4e4c00000008000001d86669464900000008000001d86974495400000008000001d86573455300000008000001d8726f524f00000008000001d86672434100000008000001d86172000000000008000001d8756b554100000008000001d86865494c00000008000001d87a68545700000008000001d87669564e00000008000001d8736b534b00000008000001d87a68434e00000008000001d87275525500000008000001d8656e474200000008000001d86672465200000008000001d86d73000000000008000001d86869494e00000008000001d87468544800000008000001d86361455300000008000001d8656e415500000008000001d86573584c00000008000001d86465444500000008000001d8656e555300000008000001d87074425200000008000001d8706c504c00000008000001d8656c475200000008000001d87376534500000008000001d87472545200000008000001d87074505400000008000001d86a614a5000000008000001d80069004d006100637465787400000000436f70797269676874204170706c6520496e632e2c2032303234000058595a20000000000000f31600010000000116ca58595a2000000000000082ca00003cb7fffffffe58595a200000000000004c4a0000b4df00000aeb58595a2000000000000027c200000e6b0000c84463757276000000000000040000000005000a000f00140019001e00230028002d00320036003b00400045004a004f00540059005e00630068006d00720077007c00810086008b00900095009a009f00a300a800ad00b200b700bc00c100c600cb00d000d500db00e000e500eb00f000f600fb01010107010d01130119011f0125012b01320138013e0145014c0152015901600167016e0175017c0183018b0192019a01a101a901b101b901c101c901d101d901e101e901f201fa0203020c0214021d0226022f02380241024b0254025d02670271027a0284028e029802a202ac02b602c102cb02d502e002eb02f50300030b03160321032d03380343034f035a03660372037e038a039603a203ae03ba03c703d303e003ec03f9040604130420042d043b0448045504630471047e048c049a04a804b604c404d304e104f004fe050d051c052b053a05490558056705770586059605a605b505c505d505e505f6060606160627063706480659066a067b068c069d06af06c006d106e306f507070719072b073d074f076107740786079907ac07bf07d207e507f8080b081f08320846085a086e0882089608aa08be08d208e708fb09100925093a094f09640979098f09a409ba09cf09e509fb0a110a270a3d0a540a6a0a810a980aae0ac50adc0af30b0b0b220b390b510b690b800b980bb00bc80be10bf90c120c2a0c430c5c0c750c8e0ca70cc00cd90cf30d0d0d260d400d5a0d740d8e0da90dc30dde0df80e130e2e0e490e640e7f0e9b0eb60ed20eee0f090f250f410f5e0f7a0f960fb30fcf0fec1009102610431061107e109b10b910d710f511131131114f116d118c11aa11c911e81207122612451264128412a312c312e31303132313431363138313a413c513e5140614271449146a148b14ad14ce14f01512153415561578159b15bd15e0160316261649166c168f16b216d616fa171d17411765178917ae17d217f7181b18401865188a18af18d518fa19201945196b199119b719dd1a041a2a1a511a771a9e1ac51aec1b141b3b1b631b8a1bb21bda1c021c2a1c521c7b1ca31ccc1cf51d1e1d471d701d991dc31dec1e161e401e6a1e941ebe1ee91f131f3e1f691f941fbf1fea20152041206c209820c420f0211c2148217521a121ce21fb22272255228222af22dd230a23382366239423c223f0241f244d247c24ab24da250925382568259725c725f726272657268726b726e827182749277a27ab27dc280d283f287128a228d429062938296b299d29d02a022a352a682a9b2acf2b022b362b692b9d2bd12c052c392c6e2ca22cd72d0c2d412d762dab2de12e162e4c2e822eb72eee2f242f5a2f912fc72ffe3035306c30a430db3112314a318231ba31f2322a3263329b32d4330d3346337f33b833f1342b3465349e34d83513354d358735c235fd3637367236ae36e937243760379c37d738143850388c38c839053942397f39bc39f93a363a743ab23aef3b2d3b6b3baa3be83c273c653ca43ce33d223d613da13de03e203e603ea03ee03f213f613fa23fe24023406440a640e74129416a41ac41ee4230427242b542f7433a437d43c044034447448a44ce45124555459a45de4622466746ab46f04735477b47c04805484b489148d7491d496349a949f04a374a7d4ac44b0c4b534b9a4be24c2a4c724cba4d024d4a4d934ddc4e254e6e4eb74f004f494f934fdd5027507150bb51065150519b51e65231527c52c75313535f53aa53f65442548f54db5528557555c2560f565c56a956f75744579257e0582f587d58cb591a596959b85a075a565aa65af55b455b955be55c355c865cd65d275d785dc95e1a5e6c5ebd5f0f5f615fb36005605760aa60fc614f61a261f56249629c62f06343639763eb6440649464e9653d659265e7663d669266e8673d679367e9683f689668ec6943699a69f16a486a9f6af76b4f6ba76bff6c576caf6d086d606db96e126e6b6ec46f1e6f786fd1702b708670e0713a719571f0724b72a67301735d73b87414747074cc7528758575e1763e769b76f8775677b37811786e78cc792a798979e77a467aa57b047b637bc27c217c817ce17d417da17e017e627ec27f237f847fe5804780a8810a816b81cd8230829282f4835783ba841d848084e3854785ab860e867286d7873b879f8804886988ce8933899989fe8a648aca8b308b968bfc8c638cca8d318d988dff8e668ece8f368f9e9006906e90d6913f91a89211927a92e3934d93b69420948a94f4955f95c99634969f970a977597e0984c98b89924999099fc9a689ad59b429baf9c1c9c899cf79d649dd29e409eae9f1d9f8b9ffaa069a0d8a147a1b6a226a296a306a376a3e6a456a4c7a538a5a9a61aa68ba6fda76ea7e0a852a8c4a937a9a9aa1caa8fab02ab75abe9ac5cacd0ad44adb8ae2daea1af16af8bb000b075b0eab160b1d6b24bb2c2b338b3aeb425b49cb513b58ab601b679b6f0b768b7e0b859b8d1b94ab9c2ba3bbab5bb2ebba7bc21bc9bbd15bd8fbe0abe84beffbf7abff5c070c0ecc167c1e3c25fc2dbc358c3d4c451c4cec54bc5c8c646c6c3c741c7bfc83dc8bcc93ac9b9ca38cab7cb36cbb6cc35ccb5cd35cdb5ce36ceb6cf37cfb8d039d0bad13cd1bed23fd2c1d344d3c6d449d4cbd54ed5d1d655d6d8d75cd7e0d864d8e8d96cd9f1da76dafbdb80dc05dc8add10dd96de1cdea2df29dfafe036e0bde144e1cce253e2dbe363e3ebe473e4fce584e60de696e71fe7a9e832e8bce946e9d0ea5beae5eb70ebfbec86ed11ed9cee28eeb4ef40efccf058f0e5f172f1fff28cf319f3a7f434f4c2f550f5def66df6fbf78af819f8a8f938f9c7fa57fae7fb77fc07fc98fd29fdbafe4bfedcff6dffff706172610000000000030000000266660000f2a700000d59000013d000000a5b7663677400000000000000010001000000000000000100000001000000000000000100000001000000000000000100006e64696e00000000000000360000ae4000005140000043c00000b0c00000268000000d80000050000000544000023333300023333300233333000000000000000006d6d6f6400000000000006100000ae1f50e5a070d478cfdd000000000000000000000000000000007663677000000000000300000002666600030000000266660003000000026666000000023333340000000002333334000000000233333400ffc00011080046009403012200021101031101ffc4001f0000010501010101010100000000000000000102030405060708090a0bffc400b5100002010303020403050504040000017d01020300041105122131410613516107227114328191a1082342b1c11552d1f02433627282090a161718191a25262728292a3435363738393a434445464748494a535455565758595a636465666768696a737475767778797a838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae1e2e3e4e5e6e7e8e9eaf1f2f3f4f5f6f7f8f9faffc4001f0100030101010101010101010000000000000102030405060708090a0bffc400b51100020102040403040705040400010277000102031104052131061241510761711322328108144291a1b1c109233352f0156272d10a162434e125f11718191a262728292a35363738393a434445464748494a535455565758595a636465666768696a737475767778797a82838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae2e3e4e5e6e7e8e9eaf2f3f4f5f6f7f8f9faffdb0043001c1c1c1c1c1c301c1c3044303030445c444444445c745c5c5c5c5c748c7474747474748c8c8c8c8c8c8c8ca8a8a8a8a8a8c4c4c4c4c4dcdcdcdcdcdcdcdcdcdcffdb00430122242438343860343460e69c809ce6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6e6ffdd0004000affda000c03010002110311003f00e928a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a00ffd0e928a28a0028a4240193c01598dac5886c6e247a8071401a9512cf0bb98d1d59875008c8c551b2bd9ef1cb795b61c1c313c920d7385a686f66ba879f2a439fa126803b6a89e786260b23aa93d0120669a97313db8b907e4c6ecd71f3c92dcdc25db8c2c8f85fa291fe3401dabba46a5e460aa3b9e0541f6db3ff009ec9ff007d0aabac7fc83e4ff80ff3155acb4cb29ad239248f2ccb92727fc6803691d241ba360c3d41cd41f6db3ff9ec9ff7d0ac258bec1ab2436ec76498c8fae7f975ab977a658c76d2c891e195490727ae3eb401a1f6db3ff9ec9ff7d0a95a7851048eea15ba12460d61699a7d9dc5a09664dcc49e7247f234fd6d163b28a3418556000f600d006b0bdb33c0993fefa1561595c6e52083dc565269360f12931f240e727fc6b3668a4d1a759a062d0b9c153fcbfc2803a8a2914860197907914b40051451401fffd1e928a28a00a3a9a48f632ac7c9c76f4cf354aceef4f4d3d51d946170ca7a93df8ef9ab7aab05b1932db32303dfdbf1ac4b78ee846ae2ca3718e091c9f7393fd28034743575b462dc2b312bf4c0a834d4592f2f11c65589047e26af58df8b976b778fca9107ddf6aafa6c52c77b72ee8ca198e09180793d280330db5e24a74b5cf94cdbb38edfe7f5ab5ab46909b48a31855240ff00c76ba4ac3d5e196596dcc68cc158e7009c74a00b3ac7fc83e4ff0080ff003159d6b06aed6c860991508e01eb8ffbe6b4f554792c5d2352cc71c0193d454d60ac96712b82085e41e0d0062e9a025fbc77809b8ecc4e7f2fc2b6efbfe3ce6ff71bf95666a30ca97d05dc28cd8e1b6827a1f6f635a978acf692aa824942001f4a00a5a2ff00c782ff00bc7f9d43af7fc7aa7fbe3f91ab3a44724564a92295393c118350eb714b2db22c4a5c87ce1467b1a00d587fd527fba3f95646bcca2d154f52e31f91a62ea37ca8116cdf2063273fe14c4b3bcbf9d67bf1b117a27f9fd68036ed815b6895ba845cfe553514500145145007ffd2e928a28a00a77f69f6db730e7690720fb8aa49fdb51a88f113638dc7fc8fe55b345006658d8c90caf7572c1a57e0e3a015a745140051451400514514005145140051451400514514005145140051451401ffd3e928a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a00ffd9"
	var invalidDataGroupHex = "00"
	var csca = utils.HexToBytes("308205FA308203E2A0030201020204492EAE16300D06092A864886F70D01010B05003041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479301E170D3130303332343134303230315A170D3236303732343134333230315A3041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F7269747930820222300D06092A864886F70D01010105000382020F003082020A0282020100C3583682D60EE9DB5E77F3CD27F02C8657ABA30C70A21EBC33FCAFA8E96B5806A090EF29CDC8A4A286F750C4F237CE89A207D460DED39854CFF2BA8F4E7807C655FE1B60E7459FF7E24DE2806EA6823BA8B3DD0A00C80B3DCB8BAE3C4620D9F5A81E3144E7805C96F147AFB13D6C9BAAB3D469EFCA9EADACAD81ED623FCCA82263D72350F553C17DE29352F937CA3EEFDAA902FE718EFC5F90CE9B35027E5F56CD92FDE396B2ACD2C8A83A7F5712CF7DF298607D072B8E82C5DD94BE323D293ADBD25B4F53467AAAE53E92BDD23E26B5501DA24B53E1F492917CA0FA8C59680FB17C952AC642944639B385A06315C251B204DD922E2F86A1D40F1FE3626E602D8D9ED0870C5D0E86ACB0E3845557E63CBB327D9EFFECD317A31FA337AEAC6F9304EB59B63DFEA4D7EC7AC94891D5D8B14F4FB4DB1AA4A88AD5B339FE7DCB460F8231F5B0628A6EA75C3FC252BF00C0D54D850D489346F3753A476A0EA237CAF9001CE729BB2EC2CEA6368F040A2B1B1108A2133EFFE4CA369D043D58A72D0AC1202138CCA1A370B26D576DA079DBDD6C59989F1E40F670AF27E28231ED3F7A5C7F1F699B9AB217F7125993CDA5C0B25147A0C37D08098B85D8B4F231303B1DF92EFAF03E31D92DE00D6971FD4D43971C318DCCB3F1FE908520F5AA788EADE562D0B23F85FF76340C5D181811B2C19529387807EBDD7C5AB09D971F0D3AB516AD0203010001A381F93081F6300E0603551D0F0101FF04040302010630120603551D130101FF040830060101FF02010030630603551D1F045C305A3058A056A054A4523050310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479310D300B0603550403130443524C31302B0603551D1004243022800F32303130303332343134303230315A810F32303236303732343134333230315A301F0603551D230418301680144531A5B73BCF8BB27C7FAC88C74B4505F6C936B3301D0603551D0E041604144531A5B73BCF8BB27C7FAC88C74B4505F6C936B3300D06092A864886F70D01010B0500038202010054F23F6A723698B06338E7A37FB2C740506E2175970C76E20D629D0AB5557359360826E7A611B3748470C1E7995952547C1BB790F4899D258F9127F6C4730F5FF63A8498EAEB50FAF767283B73325B968B497E8C6361073EC25DA7E4C225F36E5870D5874F11BC102F4DC2FEE784F3B3CB9AF3BD3C55F5A72C1883EB2632153B16F594AA086D549228CF0013199D66899181BE47AC0EF37D5F4FE7CB23B8565CD7F4099968DD90791E8EAAE871914BB25C4ABC5556D8387D4964CD87051088431FC32AAC31E37DCEE14BA835C9618E1365216BD227563D99520FD03B101CA7EABFE326BA71B4DE40DA328B2F65E99B591B01FC132C9713BF525238FEDE68A509653C196AA73404D970509D7112EFBC62F385F9642DDE0FBFC7228E0AB388C69E0304B617CC56E4B6253FBD005B22AFF67420F51069AE8D2DC9E5F076E33016AA4E1BBE11A3B79CBA4E41002021639126B7DDC79DC6DF2CD2C1DDB706B825125514F8E5797C409B1B69A8EADA1E95E1FAD139F7C1E189008A5BAB74DF7E87830AF1FBDFC27BD1985CF8DFE5C631AA4F7C0D439D80FB35B34F7722FC0EFBD2B88B4C4BC918EE4E5BD868EB49E1B6858696B364BCEC7D69E494E7DA8198D69A6ABE1F31D01502F5E78550808C2F14CD447E0E56ACDF01A5A145C52EC867232091F1C71800654CC7529557C3414667F9711275B36E92196DD8D600587D4E93FD08D3")

	testCases := []struct {
		dataGroupName string
		dataGroupHex  string
	}{
		{"DG11", invalidDataGroupHex},
		{"DG12", invalidDataGroupHex},
		{"DG13", invalidDataGroupHex},
		{"DG14", invalidDataGroupHex},
		{"DG16", invalidDataGroupHex},
	}

	for _, tc := range testCases {
		t.Run(fmt.Sprintf("invalid %s is ignored gracefully", tc.dataGroupName), func(t *testing.T) {
			data := models.PassportValidationRequest{
				DataGroups: map[string]string{
					"DG1":           dg1Hex,
					"DG2":           dg2Hex,
					tc.dataGroupName: tc.dataGroupHex,
				},
				EFSOD: sodHex,
			}

			var trustedCerts cms.GenericCertPool
			err := trustedCerts.Add(csca)
			require.NoError(t, err)

			doc, err := PassiveAuthentication(data, &trustedCerts)
			require.NoError(t, err, "should not fail when %s is invalid", tc.dataGroupName)

			// Verify that the invalid data group was not set
			switch tc.dataGroupName {
			case "DG11":
				require.Nil(t, doc.Mf.Lds1.Dg11)
			case "DG12":
				require.Nil(t, doc.Mf.Lds1.Dg12)
			case "DG13":
				require.Nil(t, doc.Mf.Lds1.Dg13)
			case "DG14":
				require.Nil(t, doc.Mf.Lds1.Dg14)
			case "DG16":
				require.Nil(t, doc.Mf.Lds1.Dg16)
			}
		})
	}
}

func TestPassiveAuthenticationMandatoryDataGroups(t *testing.T) {
	// Test data from gmrtd test cases (expired UK passport)
	var sodHex = "778207853082078106092A864886F70D010702A08207723082076E020103310D300B0609608648016503040201306E0606678108010101A06404623060020100300B0609608648016503040201304E30250201010420CA34A2808CA60C6671EC66F4E1229ADF0474BF1A7E099A05946B999438D511AD302502010204205F03553723906ACBE6B68B52F639F73B9F9E3C3135BC87E6E3D511C922AC7D20A08204F8308204F4308202DCA0030201020204492EBA13300D06092A864886F70D01010B05003041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479301E170D3131303830313132353535335A170D3232313230313031323535335A304F310B3009060355040613026762310D300B060355040A1304756B7073310F300D060355040B13066C6F6E646F6E3120301E06035504031317446F63756D656E74205369676E696E67204B657920333530820122300D06092A864886F70D01010105000382010F003082010A0282010100CE65C9D95D8FADB3C2AEABAB99220F96B5880F69AE651B3A7A378E293099B343BD1CB58FD28F0FD2F0166EA05273ECA9A3BE315397A7C6951C3FD09DCFF864C5F4B763F89851C8F9632E63D819C9EC905B90DA9D78FE0376F7218FE4B51EE88C66ECED44F4F98FEDFDBDD920484DA7AEE39E199196895DDC2C58ECF16B72D6E84770DE10793434C42FE01B8E7FC5DB7C38D7ACDEC5C1476CF1E69152E9D31CAEC122AF71280078AE054509F1CFEFC1340797FDAFCEAE5B4CBA8EDC7AB391DE69649CF9A33CA2596718E887C948EEA60BD99AA0E80C88FF94FA6FB78EEFAE98F4EC2CACC201D7EED96126292A23C4F9452D5EFF66333CC6DBE3E2EEDC3EC360DF0203010001A381E53081E2302B0603551D1004243022800F32303131303830313133323535335A810F32303131313130333133323535335A300E0603551D0F0101FF04040302078030630603551D1F045C305A3058A056A054A4523050310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479310D300B0603550403130443524C34301F0603551D230418301680144531A5B73BCF8BB27C7FAC88C74B4505F6C936B3301D0603551D0E0416041467B8149943C5F8C949BC846A34DBE7E05D241404300D06092A864886F70D01010B050003820201005BFB66391196171815A26AE99FD1653B7F6C9FFB751BBD69ADEF0B4182C043C4726FD826C8011BF12DA9374A79963613672C84289671EC31D53CA73E23E0A119F884B5D5836CE1F9DD03787624ABBDFEF475F16D5BFFFD719DE0B0FD1C0FE9D0E8064C6F77372CBBB00E1E43715A157EFB5F3D97E60A5018B6F07E7C735067FC73480B393D8945D09ED79F3D9C3F6299B7F2A2FC5829ABCE927C23010FE74788AF2AC7D38A08075C4559E256ECF8CB62BC27316FB477A79653A836EC03032CFA2FDF009EE6C9B5A102C91C381C0B941952A22AF5DAF9552A8A7F70D1F5847C8D3762CC7A2C0B44CC12A74C6CB410985641979B4CAD092A199A7371716592B9BC0A8691B60D830E13E749B31FFE120E0E2C98E2DE1C745ED16D3D2DF7205DDDC34C1B06413C28C9DC11C1F03F3E0A20321D8ACC13183EE003CE36DCA354E8053145F6055451C3F6A2A8E40998C5EF40609E431894C524CA9A7523B8B3BD667BD09F1F9E0EAC7602E1B8758F82EE61DA953E9B188ADF5A382D23EE4137F50B0A7AE8833AF55D5F0DD9E6E5D71B2A2543FBFAA2F7902D8E1BD656B6654264E108792E70C68227CE7F58C5C866D5CCFD3572941F21CFC2AA85EAEC84B4C6988C75BEC1711F11149356DC40119F4B023154BCED5B581FD71FEC2BC106D737E8D1F9704C5686A182C0148CA90B93CA17DD2797FBA2619F69D3F8474BC9D9493A33F45A318201EC308201E802010130493041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F726974790204492EBA13300B0609608648016503040201A048301506092A864886F70D01090331080606678108010101302F06092A864886F70D010904312204206A2DFFE58D6A59A5AAE942C2BAF9A585B4B20E63C4B7ED0CE4B497FFC7F80992303D06092A864886F70D01010A3030A00D300B0609608648016503040201A11A301806092A864886F70D010108300B0609608648016003040201A203020120048201007465E8179610CC7D48D7F2AB0A88FD939E5CAB0D7226874F5647AA1A97911CF61DED88DA44D1AEC330C7045E3B5DFB7A79F19698C12D659BC37B8E98375D130ADEC2BD6688A57C996D9FC2DC8E0E2594BFA3E43E4FD7E63A7895435182D566F749C39FB4E948658E58769F871E665FA92C4C620DF2940DA028C72F2B05B4FA35E16201BD912AB7F6E4C07116E6086724C2009C2C29C2B83050546EE29CB162B975EF2A9718CDEC2737518D282CBA5B11A95707EA3DC915047A8906181B3E4FE823EA34A5C1BF7A93D5510EA8A7A355385C344E76647EF73AFF9270CC678D6DBAD06088C950E2BFC2DF382E48D765ACC6E4207E09457011AC72EBB4DBABB81611"
	var dg1Hex = "615B5F1F58503C47425253414E444552534F4E3C3C4F534341523C434841524C45533C4544574152443C3C3C3C3C3C3C3C30393932353036393236474252373830343035364D323230373137393C3C3C3C3C3C3C3C3C3C3C3C3C3C3032"
	var invalidDG15Hex = "00"
	var csca = utils.HexToBytes("308205FA308203E2A0030201020204492EAE16300D06092A864886F70D01010B05003041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479301E170D3130303332343134303230315A170D3236303732343134333230315A3041310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F7269747930820222300D06092A864886F70D01010105000382020F003082020A0282020100C3583682D60EE9DB5E77F3CD27F02C8657ABA30C70A21EBC33FCAFA8E96B5806A090EF29CDC8A4A286F750C4F237CE89A207D460DED39854CFF2BA8F4E7807C655FE1B60E7459FF7E24DE2806EA6823BA8B3DD0A00C80B3DCB8BAE3C4620D9F5A81E3144E7805C96F147AFB13D6C9BAAB3D469EFCA9EADACAD81ED623FCCA82263D72350F553C17DE29352F937CA3EEFDAA902FE718EFC5F90CE9B35027E5F56CD92FDE396B2ACD2C8A83A7F5712CF7DF298607D072B8E82C5DD94BE323D293ADBD25B4F53467AAAE53E92BDD23E26B5501DA24B53E1F492917CA0FA8C59680FB17C952AC642944639B385A06315C251B204DD922E2F86A1D40F1FE3626E602D8D9ED0870C5D0E86ACB0E3845557E63CBB327D9EFFECD317A31FA337AEAC6F9304EB59B63DFEA4D7EC7AC94891D5D8B14F4FB4DB1AA4A88AD5B339FE7DCB460F8231F5B0628A6EA75C3FC252BF00C0D54D850D489346F3753A476A0EA237CAF9001CE729BB2EC2CEA6368F040A2B1B1108A2133EFFE4CA369D043D58A72D0AC1202138CCA1A370B26D576DA079DBDD6C59989F1E40F670AF27E28231ED3F7A5C7F1F699B9AB217F7125993CDA5C0B25147A0C37D08098B85D8B4F231303B1DF92EFAF03E31D92DE00D6971FD4D43971C318DCCB3F1FE908520F5AA788EADE562D0B23F85FF76340C5D181811B2C19529387807EBDD7C5AB09D971F0D3AB516AD0203010001A381F93081F6300E0603551D0F0101FF04040302010630120603551D130101FF040830060101FF02010030630603551D1F045C305A3058A056A054A4523050310B3009060355040613026762310E300C060355040A1305554B4B50413122302006035504031319436F756E747279205369676E696E6720417574686F72697479310D300B0603550403130443524C31302B0603551D1004243022800F32303130303332343134303230315A810F32303236303732343134333230315A301F0603551D230418301680144531A5B73BCF8BB27C7FAC88C74B4505F6C936B3301D0603551D0E041604144531A5B73BCF8BB27C7FAC88C74B4505F6C936B3300D06092A864886F70D01010B0500038202010054F23F6A723698B06338E7A37FB2C740506E2175970C76E20D629D0AB5557359360826E7A611B3748470C1E7995952547C1BB790F4899D258F9127F6C4730F5FF63A8498EAEB50FAF767283B73325B968B497E8C6361073EC25DA7E4C225F36E5870D5874F11BC102F4DC2FEE784F3B3CB9AF3BD3C55F5A72C1883EB2632153B16F594AA086D549228CF0013199D66899181BE47AC0EF37D5F4FE7CB23B8565CD7F4099968DD90791E8EAAE871914BB25C4ABC5556D8387D4964CD87051088431FC32AAC31E37DCEE14BA835C9618E1365216BD227563D99520FD03B101CA7EABFE326BA71B4DE40DA328B2F65E99B591B01FC132C9713BF525238FEDE68A509653C196AA73404D970509D7112EFBC62F385F9642DDE0FBFC7228E0AB388C69E0304B617CC56E4B6253FBD005B22AFF67420F51069AE8D2DC9E5F076E33016AA4E1BBE11A3B79CBA4E41002021639126B7DDC79DC6DF2CD2C1DDB706B825125514F8E5797C409B1B69A8EADA1E95E1FAD139F7C1E189008A5BAB74DF7E87830AF1FBDFC27BD1985CF8DFE5C631AA4F7C0D439D80FB35B34F7722FC0EFBD2B88B4C4BC918EE4E5BD868EB49E1B6858696B364BCEC7D69E494E7DA8198D69A6ABE1F31D01502F5E78550808C2F14CD447E0E56ACDF01A5A145C52EC867232091F1C71800654CC7529557C3414667F9711275B36E92196DD8D600587D4E93FD08D3")

	t.Run("invalid DG1 fails", func(t *testing.T) {
		data := models.PassportValidationRequest{
			DataGroups: map[string]string{
				"DG1": "00",
			},
			EFSOD: sodHex,
		}

		var trustedCerts cms.GenericCertPool
		err := trustedCerts.Add(csca)
		require.NoError(t, err)

		_, err = PassiveAuthentication(data, &trustedCerts)
		require.Error(t, err)
		require.Contains(t, err.Error(), "failed to create DG1 (mandatory)")
	})

	t.Run("invalid DG2 fails", func(t *testing.T) {
		data := models.PassportValidationRequest{
			DataGroups: map[string]string{
				"DG1": dg1Hex,
				"DG2": "00",
			},
			EFSOD: sodHex,
		}

		var trustedCerts cms.GenericCertPool
		err := trustedCerts.Add(csca)
		require.NoError(t, err)

		_, err = PassiveAuthentication(data, &trustedCerts)
		require.Error(t, err)
		require.Contains(t, err.Error(), "failed to create DG2 (mandatory)")
	})

	t.Run("invalid DG15 fails if provided", func(t *testing.T) {
		data := models.PassportValidationRequest{
			DataGroups: map[string]string{
				"DG1":  dg1Hex,
				"DG15": invalidDG15Hex,
			},
			EFSOD: sodHex,
		}

		var trustedCerts cms.GenericCertPool
		err := trustedCerts.Add(csca)
		require.NoError(t, err)

		_, err = PassiveAuthentication(data, &trustedCerts)
		require.Error(t, err)
		require.Contains(t, err.Error(), "failed to create DG15 (mandatory if provided)")
	})

	t.Run("missing DG1 fails", func(t *testing.T) {
		data := models.PassportValidationRequest{
			DataGroups: map[string]string{
				// DG1 is missing, but we include DG7 to get past the empty check
				"DG7": "675A3158561234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",
			},
			EFSOD: sodHex,
		}

		var trustedCerts cms.GenericCertPool
		err := trustedCerts.Add(csca)
		require.NoError(t, err)

		_, err = PassiveAuthentication(data, &trustedCerts)
		require.Error(t, err)
		require.Contains(t, err.Error(), "DG1 is mandatory but was not provided")
	})

	t.Run("missing DG2 fails", func(t *testing.T) {
		data := models.PassportValidationRequest{
			DataGroups: map[string]string{
				"DG1": dg1Hex,
				// DG2 is missing
			},
			EFSOD: sodHex,
		}

		var trustedCerts cms.GenericCertPool
		err := trustedCerts.Add(csca)
		require.NoError(t, err)

		_, err = PassiveAuthentication(data, &trustedCerts)
		require.Error(t, err)
		require.Contains(t, err.Error(), "DG2 is mandatory but was not provided")
	})
}
